<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coverage Report: Flightsim - UI.lua</title>
    <style>
        :root {
            --bg: #1e1e2e;
            --surface: #313244;
            --text: #cdd6f4;
            --subtext: #a6adc8;
            --green: #a6e3a1;
            --yellow: #f9e2af;
            --red: #f38ba8;
            --blue: #89b4fa;
            --border: #45475a;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 2rem;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 {
            color: var(--blue);
            margin-bottom: 0.5rem;
            font-size: 1.75rem;
        }
        .timestamp {
            color: var(--subtext);
            font-size: 0.875rem;
            margin-bottom: 2rem;
        }
        .summary-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }
        .stat {
            text-align: center;
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
        }
        .stat-label {
            color: var(--subtext);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .coverage-high { color: var(--green); }
        .coverage-medium { color: var(--yellow); }
        .coverage-low { color: var(--red); }
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface);
            border-radius: 12px;
            overflow: hidden;
        }
        th, td {
            padding: 0.875rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        th {
            background: rgba(0,0,0,0.2);
            font-weight: 600;
            color: var(--subtext);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }
        tr:hover { background: rgba(255,255,255,0.02); }
        tr:last-child td { border-bottom: none; }
        .file-link {
            color: var(--blue);
            text-decoration: none;
        }
        .file-link:hover { text-decoration: underline; }
        .progress-bar {
            width: 100px;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .text-right { text-align: right; }
        .file-detail {
            background: var(--surface);
            border-radius: 12px;
            margin-top: 2rem;
            overflow: hidden;
        }
        .file-header {
            padding: 1rem 1.5rem;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .file-name {
            font-family: 'Consolas', 'Monaco', monospace;
            color: var(--blue);
        }
        .code-view {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.875rem;
            overflow-x: auto;
        }
        .code-line {
            display: flex;
            min-height: 1.5rem;
        }
        .line-number {
            width: 50px;
            padding: 0 0.75rem;
            text-align: right;
            color: var(--subtext);
            user-select: none;
            flex-shrink: 0;
            background: rgba(0,0,0,0.1);
        }
        .line-content {
            flex: 1;
            padding: 0 1rem;
            white-space: pre;
        }
        .line-covered {
            background: rgba(166, 227, 161, 0.1);
        }
        .line-uncovered {
            background: rgba(243, 139, 168, 0.15);
        }
        .line-uncovered .line-number {
            background: rgba(243, 139, 168, 0.2);
            color: var(--red);
        }
        .nav { margin-bottom: 1rem; }
        .nav a {
            color: var(--blue);
            text-decoration: none;
            margin-right: 1rem;
        }
        .nav a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        
        <div class="nav">
            <a href="index.html">‚Üê Back to Summary</a>
        </div>
        
        <div class="file-detail">
            <div class="file-header">
                <span class="file-name">UI.lua</span>
                <span class="coverage-low">7.6% (92/1216 lines)</span>
            </div>
            <div class="code-view">
    
                <div class="code-line ">
                    <span class="line-number">1</span>
                    <span class="line-content">FlightsimUI = FlightsimUI or {}</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">2</span>
                    <span class="line-content">FlightsimUI.Utils = FlightsimUI.Utils or {}</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">3</span>
                    <span class="line-content">FlightsimUI.debugBuffer = {}</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">4</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">5</span>
                    <span class="line-content">-- Performance Tracking</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">6</span>
                    <span class="line-content">FlightsimUI.perf = {</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">7</span>
                    <span class="line-content">	blocks = {</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">8</span>
                    <span class="line-content">		state = 0,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">9</span>
                    <span class="line-content">		speed = 0,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">10</span>
                    <span class="line-content">		accel = 0,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">11</span>
                    <span class="line-content">		prep = 0,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">12</span>
                    <span class="line-content">		surge = 0,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">13</span>
                    <span class="line-content">		whirling = 0,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">14</span>
                    <span class="line-content">		wind = 0,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">15</span>
                    <span class="line-content">	},</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">16</span>
                    <span class="line-content">	lastUpdate = 0,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">17</span>
                    <span class="line-content">}</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">18</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">19</span>
                    <span class="line-content">-- Testing Definitions</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">20</span>
                    <span class="line-content">FlightsimUI.tests = {</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">21</span>
                    <span class="line-content">	{ id = &quot;api_diag&quot;, name = &quot;API Diagnostic&quot;, category = &quot;API Diagnostic&quot;, type = &quot;auto&quot;, description = &quot;Checks core skyriding APIs for secret values.&quot; },</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">22</span>
                    <span class="line-content">	{ id = &quot;ui_compliance&quot;, name = &quot;UI Compliance&quot;, category = &quot;UI Compliance&quot;, type = &quot;auto&quot;, description = &quot;Verifies StatusBar compliance with secret passthrough.&quot; },</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">23</span>
                    <span class="line-content">}</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">24</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">25</span>
                    <span class="line-content">local function IsSecret(val)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">26</span>
                    <span class="line-content">	if val == nil then return false end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">27</span>
                    <span class="line-content">	if issecretvalue then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">28</span>
                    <span class="line-content">		return issecretvalue(val) == true</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">29</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">30</span>
                    <span class="line-content">	-- Robust fallback for secret-like objects that crash comparisons</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">31</span>
                    <span class="line-content">	local ok = pcall(function() local _ = (val &gt; -1e12) end)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">32</span>
                    <span class="line-content">	return not ok</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">33</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">34</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">35</span>
                    <span class="line-content">local function SafeToString(val)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">36</span>
                    <span class="line-content">	if val == nil then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">37</span>
                    <span class="line-content">		return &quot;nil&quot;</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">38</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">39</span>
                    <span class="line-content">	if IsSecret(val) then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">40</span>
                    <span class="line-content">		return &quot;???&quot;</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">41</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">42</span>
                    <span class="line-content">	return tostring(val)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">43</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">44</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">45</span>
                    <span class="line-content">local function SafeCompare(a, b, op)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">46</span>
                    <span class="line-content">	if a == nil or b == nil then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">47</span>
                    <span class="line-content">		return nil</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">48</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">49</span>
                    <span class="line-content">	if IsSecret(a) or IsSecret(b) then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">50</span>
                    <span class="line-content">		return nil</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">51</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">52</span>
                    <span class="line-content">	if op == &quot;&gt;&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">53</span>
                    <span class="line-content">		return a &gt; b</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">54</span>
                    <span class="line-content">	elseif op == &quot;&lt;&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">55</span>
                    <span class="line-content">		return a &lt; b</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">56</span>
                    <span class="line-content">	elseif op == &quot;&gt;=&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">57</span>
                    <span class="line-content">		return a &gt;= b</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">58</span>
                    <span class="line-content">	elseif op == &quot;&lt;=&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">59</span>
                    <span class="line-content">		return a &lt;= b</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">60</span>
                    <span class="line-content">	elseif op == &quot;==&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">61</span>
                    <span class="line-content">		return a == b</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">62</span>
                    <span class="line-content">	elseif op == &quot;~=&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">63</span>
                    <span class="line-content">		return a ~= b</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">64</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">65</span>
                    <span class="line-content">	return nil</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">66</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">67</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">68</span>
                    <span class="line-content">local function DebugLog(...)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">69</span>
                    <span class="line-content">	if not Flightsim or not Flightsim.debugMode then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">70</span>
                    <span class="line-content">		return</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">71</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">72</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">73</span>
                    <span class="line-content">	local msg = &quot;&quot;</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">74</span>
                    <span class="line-content">	local n = select(&quot;#&quot;, ...)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">75</span>
                    <span class="line-content">	for i = 1, n do</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">76</span>
                    <span class="line-content">		local v = select(i, ...)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">77</span>
                    <span class="line-content">		msg = msg .. (i &gt; 1 and &quot; &quot; or &quot;&quot;) .. SafeToString(v)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">78</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">79</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">80</span>
                    <span class="line-content">	-- Log to internal buffer for Mechanic&#x27;s pull model</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">81</span>
                    <span class="line-content">	table.insert(FlightsimUI.debugBuffer, {</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">82</span>
                    <span class="line-content">		msg = msg,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">83</span>
                    <span class="line-content">		time = GetTime(),</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">84</span>
                    <span class="line-content">	})</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">85</span>
                    <span class="line-content">	if #FlightsimUI.debugBuffer &gt; 500 then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">86</span>
                    <span class="line-content">		table.remove(FlightsimUI.debugBuffer, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">87</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">88</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">89</span>
                    <span class="line-content">	-- Log to Mechanic&#x27;s live console if available</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">90</span>
                    <span class="line-content">	local MechanicLib = LibStub(&quot;MechanicLib-1.0&quot;, true)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">91</span>
                    <span class="line-content">	if MechanicLib then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">92</span>
                    <span class="line-content">		local category = MechanicLib.Categories.CORE</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">93</span>
                    <span class="line-content">		-- Quick category heuristic</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">94</span>
                    <span class="line-content">		if msg:find(&quot;secret&quot;) or msg:find(&quot;???&quot;) then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">95</span>
                    <span class="line-content">			category = MechanicLib.Categories.SECRET</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">96</span>
                    <span class="line-content">		elseif msg:find(&quot;API&quot;) or msg:find(&quot;charges&quot;) or msg:find(&quot;GetSpell&quot;) then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">97</span>
                    <span class="line-content">			category = MechanicLib.Categories.API</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">98</span>
                    <span class="line-content">		elseif msg:find(&quot;Block&quot;) then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">99</span>
                    <span class="line-content">			category = MechanicLib.Categories.PERF</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">100</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">101</span>
                    <span class="line-content">		MechanicLib:Log(&quot;Flightsim&quot;, msg, category)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">102</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">103</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">104</span>
                    <span class="line-content">	if Flightsim.debugMode then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">105</span>
                    <span class="line-content">		print(&quot;|cff74AFFF[Flightsim]|r&quot;, msg)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">106</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">107</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">108</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">109</span>
                    <span class="line-content">local function Clamp(n, minV, maxV)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">110</span>
                    <span class="line-content">	if n &lt; minV then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">111</span>
                    <span class="line-content">		return minV</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">112</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">113</span>
                    <span class="line-content">	if n &gt; maxV then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">114</span>
                    <span class="line-content">		return maxV</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">115</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">116</span>
                    <span class="line-content">	return n</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">117</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">118</span>
                    <span class="line-content">FlightsimUI.Utils.Clamp = Clamp</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">119</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">120</span>
                    <span class="line-content">-- Blizzard-matching color palette (based on #2BA604 green)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">121</span>
                    <span class="line-content">local COLOR_GREEN = { 0.169, 0.651, 0.016 } -- #2BA604</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">122</span>
                    <span class="line-content">local COLOR_YELLOW = { 0.769, 0.651, 0.016 } -- #C4A604 (gold)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">123</span>
                    <span class="line-content">local COLOR_RED = { 0.769, 0.169, 0.016 } -- #C42B04</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">124</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">125</span>
                    <span class="line-content">-- Surge Forward color: #74AFFF (light blue)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">126</span>
                    <span class="line-content">local COLOR_SURGE_FORWARD = { 0.455, 0.686, 1.0 } -- #74AFFF</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">127</span>
                    <span class="line-content">local COLOR_SURGE_FORWARD_EMPTY = { 0.18, 0.27, 0.4 } -- Dimmed version</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">128</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">129</span>
                    <span class="line-content">-- Second Wind color: #D379EF (purple/magenta)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">130</span>
                    <span class="line-content">local COLOR_SECOND_WIND = { 0.827, 0.475, 0.937 } -- #D379EF</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">131</span>
                    <span class="line-content">local COLOR_SECOND_WIND_EMPTY = { 0.33, 0.19, 0.37 } -- Dimmed version</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">132</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">133</span>
                    <span class="line-content">-- Whirling Surge color: #4AC7D4 (cyan/teal)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">134</span>
                    <span class="line-content">local COLOR_WHIRLING_SURGE = { 0.290, 0.780, 0.831 } -- #4AC7D4</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">135</span>
                    <span class="line-content">local COLOR_WHIRLING_SURGE_EMPTY = { 0.12, 0.31, 0.33 } -- Dimmed version</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">136</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">137</span>
                    <span class="line-content">local function ColorForPct(pct)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">138</span>
                    <span class="line-content">	-- Ramp: red (0%) -&gt; yellow (50%) -&gt; green (100%)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">139</span>
                    <span class="line-content">	pct = Clamp(pct or 0, 0, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">140</span>
                    <span class="line-content">	local r, g, b</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">141</span>
                    <span class="line-content">	if pct &lt; 0.5 then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">142</span>
                    <span class="line-content">		-- red -&gt; yellow (0% to 50%)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">143</span>
                    <span class="line-content">		local t = pct * 2 -- 0 -&gt; 1 as pct goes 0 -&gt; 0.5</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">144</span>
                    <span class="line-content">		r = COLOR_RED[1] + (COLOR_YELLOW[1] - COLOR_RED[1]) * t</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">145</span>
                    <span class="line-content">		g = COLOR_RED[2] + (COLOR_YELLOW[2] - COLOR_RED[2]) * t</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">146</span>
                    <span class="line-content">		b = COLOR_RED[3] + (COLOR_YELLOW[3] - COLOR_RED[3]) * t</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">147</span>
                    <span class="line-content">	else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">148</span>
                    <span class="line-content">		-- yellow -&gt; green (50% to 100%)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">149</span>
                    <span class="line-content">		local t = (pct - 0.5) * 2 -- 0 -&gt; 1 as pct goes 0.5 -&gt; 1</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">150</span>
                    <span class="line-content">		r = COLOR_YELLOW[1] + (COLOR_GREEN[1] - COLOR_YELLOW[1]) * t</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">151</span>
                    <span class="line-content">		g = COLOR_YELLOW[2] + (COLOR_GREEN[2] - COLOR_YELLOW[2]) * t</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">152</span>
                    <span class="line-content">		b = COLOR_YELLOW[3] + (COLOR_GREEN[3] - COLOR_YELLOW[3]) * t</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">153</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">154</span>
                    <span class="line-content">	return r, g, b</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">155</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">156</span>
                    <span class="line-content">FlightsimUI.Utils.ColorForPct = ColorForPct</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">157</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">158</span>
                    <span class="line-content">local function ColorForPctBlue(pct)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">159</span>
                    <span class="line-content">	-- Simple lerp: empty -&gt; full for Whirling Surge (#4AC7D4)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">160</span>
                    <span class="line-content">	pct = Clamp(pct or 0, 0, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">161</span>
                    <span class="line-content">	local r = COLOR_WHIRLING_SURGE_EMPTY[1] + (COLOR_WHIRLING_SURGE[1] - COLOR_WHIRLING_SURGE_EMPTY[1]) * pct</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">162</span>
                    <span class="line-content">	local g = COLOR_WHIRLING_SURGE_EMPTY[2] + (COLOR_WHIRLING_SURGE[2] - COLOR_WHIRLING_SURGE_EMPTY[2]) * pct</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">163</span>
                    <span class="line-content">	local b = COLOR_WHIRLING_SURGE_EMPTY[3] + (COLOR_WHIRLING_SURGE[3] - COLOR_WHIRLING_SURGE_EMPTY[3]) * pct</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">164</span>
                    <span class="line-content">	return r, g, b</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">165</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">166</span>
                    <span class="line-content">FlightsimUI.Utils.ColorForPctBlue = ColorForPctBlue</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">167</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">168</span>
                    <span class="line-content">local function ColorForPctPurple(pct)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">169</span>
                    <span class="line-content">	-- Simple lerp: empty -&gt; full for Second Wind (#D379EF)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">170</span>
                    <span class="line-content">	pct = Clamp(pct or 0, 0, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">171</span>
                    <span class="line-content">	local r = COLOR_SECOND_WIND_EMPTY[1] + (COLOR_SECOND_WIND[1] - COLOR_SECOND_WIND_EMPTY[1]) * pct</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">172</span>
                    <span class="line-content">	local g = COLOR_SECOND_WIND_EMPTY[2] + (COLOR_SECOND_WIND[2] - COLOR_SECOND_WIND_EMPTY[2]) * pct</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">173</span>
                    <span class="line-content">	local b = COLOR_SECOND_WIND_EMPTY[3] + (COLOR_SECOND_WIND[3] - COLOR_SECOND_WIND_EMPTY[3]) * pct</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">174</span>
                    <span class="line-content">	return r, g, b</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">175</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">176</span>
                    <span class="line-content">FlightsimUI.Utils.ColorForPctPurple = ColorForPctPurple</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">177</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">178</span>
                    <span class="line-content">local function ColorForPctSurgeForward(pct)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">179</span>
                    <span class="line-content">	-- Simple lerp: empty -&gt; full for Surge Forward (#74AFFF)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">180</span>
                    <span class="line-content">	pct = Clamp(pct or 0, 0, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">181</span>
                    <span class="line-content">	local r = COLOR_SURGE_FORWARD_EMPTY[1] + (COLOR_SURGE_FORWARD[1] - COLOR_SURGE_FORWARD_EMPTY[1]) * pct</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">182</span>
                    <span class="line-content">	local g = COLOR_SURGE_FORWARD_EMPTY[2] + (COLOR_SURGE_FORWARD[2] - COLOR_SURGE_FORWARD_EMPTY[2]) * pct</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">183</span>
                    <span class="line-content">	local b = COLOR_SURGE_FORWARD_EMPTY[3] + (COLOR_SURGE_FORWARD[3] - COLOR_SURGE_FORWARD_EMPTY[3]) * pct</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">184</span>
                    <span class="line-content">	return r, g, b</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">185</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">186</span>
                    <span class="line-content">FlightsimUI.Utils.ColorForPctSurgeForward = ColorForPctSurgeForward</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">187</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">188</span>
                    <span class="line-content">-- WeakAura-inspired skyriding constants (Retail 11.x):</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">189</span>
                    <span class="line-content">-- These are used only where they map cleanly to addon-safe APIs.</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">190</span>
                    <span class="line-content">local SLOW_SKYRIDING_RATIO = 705 / 830</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">191</span>
                    <span class="line-content">-- Base speed for percentage calculation. WA uses ~8.24 y/s (approx 100% mounted ground speed)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">192</span>
                    <span class="line-content">-- so that max skyriding (~65 y/s) shows as ~790% rather than ~930%.</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">193</span>
                    <span class="line-content">local BASE_SPEED_FOR_PCT = 8.24</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">194</span>
                    <span class="line-content">local FAST_FLYING_ZONES = {</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">195</span>
                    <span class="line-content">	[2444] = true, -- Dragon Isles</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">196</span>
                    <span class="line-content">	[2454] = true, -- Zaralek Cavern</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">197</span>
                    <span class="line-content">	[2548] = true, -- Emerald Dream</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">198</span>
                    <span class="line-content">	[2516] = true, -- Nokhud Offensive</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">199</span>
                    <span class="line-content">	[2522] = true, -- Vault of the Incarnates</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">200</span>
                    <span class="line-content">	[2569] = true, -- Aberrus, the Shadowed Crucible</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">201</span>
                    <span class="line-content">}</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">202</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">203</span>
                    <span class="line-content">-- Spell IDs for ability tracking</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">204</span>
                    <span class="line-content">local WHIRLING_SURGE_SPELL_ID = 361584</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">205</span>
                    <span class="line-content">local SECOND_WIND_SPELL_ID = 425782 -- Second Wind (restores Surge Forward charges)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">206</span>
                    <span class="line-content">local SURGE_FORWARD_SPELL_ID = 372608 -- Surge Forward (6 charges)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">207</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">208</span>
                    <span class="line-content">local function GetUnitSpeedSafe(unit)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">209</span>
                    <span class="line-content">	local fn = GetUnitSpeed or UnitSpeed</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">210</span>
                    <span class="line-content">	if type(fn) == &quot;function&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">211</span>
                    <span class="line-content">		local ok, result = pcall(fn, unit)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">212</span>
                    <span class="line-content">		if ok and result then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">213</span>
                    <span class="line-content">			-- In Midnight combat, result may be a secret value (not a number).</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">214</span>
                    <span class="line-content">			-- We return it anyway so it can be passed to StatusBars.</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">215</span>
                    <span class="line-content">			return result</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">216</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">217</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">218</span>
                    <span class="line-content">	return 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">219</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">220</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">221</span>
                    <span class="line-content">local function IsSlowSkyridingZone()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">222</span>
                    <span class="line-content">	if type(GetInstanceInfo) ~= &quot;function&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">223</span>
                    <span class="line-content">		return false</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">224</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">225</span>
                    <span class="line-content">	local instanceID = select(8, GetInstanceInfo())</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">226</span>
                    <span class="line-content">	if type(instanceID) ~= &quot;number&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">227</span>
                    <span class="line-content">		return false</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">228</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">229</span>
                    <span class="line-content">	return not FAST_FLYING_ZONES[instanceID]</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">230</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">231</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">232</span>
                    <span class="line-content">function FlightsimUI:_UpdateSkyridingState(now)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">233</span>
                    <span class="line-content">	-- Zone normalization (WA behavior): treat some zones as &quot;slow&quot; and scale up.</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">234</span>
                    <span class="line-content">	self._isSlowSkyriding = IsSlowSkyridingZone()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">235</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">236</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">237</span>
                    <span class="line-content">function FlightsimUI:_GetSkyridingSpeed(now)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">238</span>
                    <span class="line-content">	-- Returns: speed, isGliding</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">239</span>
                    <span class="line-content">	if C_PlayerInfo and type(C_PlayerInfo.GetGlidingInfo) == &quot;function&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">240</span>
                    <span class="line-content">		local ok, isGliding, _, forwardSpeed = pcall(C_PlayerInfo.GetGlidingInfo)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">241</span>
                    <span class="line-content">		if ok and isGliding then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">242</span>
                    <span class="line-content">			-- In Midnight combat, forwardSpeed may be a secret value.</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">243</span>
                    <span class="line-content">			-- isGliding will be true if secret or boolean true.</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">244</span>
                    <span class="line-content">			local adjusted = forwardSpeed</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">245</span>
                    <span class="line-content">			if not (issecretvalue and issecretvalue(adjusted)) then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">246</span>
                    <span class="line-content">			if self._isSlowSkyriding then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">247</span>
                    <span class="line-content">				adjusted = adjusted / SLOW_SKYRIDING_RATIO</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">248</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">249</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">250</span>
                    <span class="line-content">			return adjusted, true</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">251</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">252</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">253</span>
                    <span class="line-content">	return 0, false</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">254</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">255</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">256</span>
                    <span class="line-content">local function GetSpellChargesSafe(spellID)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">257</span>
                    <span class="line-content">	spellID = tonumber(spellID)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">258</span>
                    <span class="line-content">	if not spellID then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">259</span>
                    <span class="line-content">		return nil, nil</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">260</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">261</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">262</span>
                    <span class="line-content">	-- Some client builds prune/rename the global. Prefer the global if present,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">263</span>
                    <span class="line-content">	-- otherwise fall back to C_Spell.GetSpellCharges if available.</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">264</span>
                    <span class="line-content">	if type(GetSpellCharges) == &quot;function&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">265</span>
                    <span class="line-content">		local ok, cur, max = pcall(GetSpellCharges, spellID)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">266</span>
                    <span class="line-content">		if ok then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">267</span>
                    <span class="line-content">			return cur, max</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">268</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">269</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">270</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">271</span>
                    <span class="line-content">	if C_Spell and type(C_Spell.GetSpellCharges) == &quot;function&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">272</span>
                    <span class="line-content">		local ok, a, b = pcall(C_Spell.GetSpellCharges, spellID)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">273</span>
                    <span class="line-content">		if ok then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">274</span>
                    <span class="line-content">			if type(a) == &quot;table&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">275</span>
                    <span class="line-content">				-- FrameXML typically returns a table with currentCharges/maxCharges.</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">276</span>
                    <span class="line-content">				local cur = a.currentCharges</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">277</span>
                    <span class="line-content">				if cur == nil then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">278</span>
                    <span class="line-content">					cur = a.charges</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">279</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">280</span>
                    <span class="line-content">				local max = a.maxCharges</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">281</span>
                    <span class="line-content">				if max == nil then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">282</span>
                    <span class="line-content">					max = a.max</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">283</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">284</span>
                    <span class="line-content">				return cur, max</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">285</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">286</span>
                    <span class="line-content">			-- Some builds may return (currentCharges, maxCharges, ...)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">287</span>
                    <span class="line-content">			return a, b</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">288</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">289</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">290</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">291</span>
                    <span class="line-content">	return nil, nil</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">292</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">293</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">294</span>
                    <span class="line-content">-- Reusable table for GetSpellCooldownSafe to avoid per-frame allocations</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">295</span>
                    <span class="line-content">local _cooldownResult = {</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">296</span>
                    <span class="line-content">	startTime = nil,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">297</span>
                    <span class="line-content">	duration = nil,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">298</span>
                    <span class="line-content">	isEnabled = nil,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">299</span>
                    <span class="line-content">	currentCharges = nil,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">300</span>
                    <span class="line-content">	maxCharges = nil,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">301</span>
                    <span class="line-content">	chargeStart = nil,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">302</span>
                    <span class="line-content">	chargeDuration = nil,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">303</span>
                    <span class="line-content">}</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">304</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">305</span>
                    <span class="line-content">-- Returns a table with cooldown and charge info for a spell</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">306</span>
                    <span class="line-content">-- { startTime, duration, isEnabled, currentCharges, maxCharges, chargeStart, chargeDuration }</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">307</span>
                    <span class="line-content">-- NOTE: Returns a reused table - do not store references to the result!</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">308</span>
                    <span class="line-content">local function GetSpellCooldownSafe(spellID, getCharges)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">309</span>
                    <span class="line-content">	spellID = tonumber(spellID)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">310</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">311</span>
                    <span class="line-content">	-- Reset the reusable table</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">312</span>
                    <span class="line-content">	_cooldownResult.startTime = nil</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">313</span>
                    <span class="line-content">	_cooldownResult.duration = nil</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">314</span>
                    <span class="line-content">	_cooldownResult.isEnabled = nil</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">315</span>
                    <span class="line-content">	_cooldownResult.currentCharges = nil</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">316</span>
                    <span class="line-content">	_cooldownResult.maxCharges = nil</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">317</span>
                    <span class="line-content">	_cooldownResult.chargeStart = nil</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">318</span>
                    <span class="line-content">	_cooldownResult.chargeDuration = nil</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">319</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">320</span>
                    <span class="line-content">	if not spellID then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">321</span>
                    <span class="line-content">		return _cooldownResult</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">322</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">323</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">324</span>
                    <span class="line-content">	-- Try C_Spell.GetSpellCooldown first (modern API)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">325</span>
                    <span class="line-content">	if C_Spell and type(C_Spell.GetSpellCooldown) == &quot;function&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">326</span>
                    <span class="line-content">		local ok, cdInfo = pcall(C_Spell.GetSpellCooldown, spellID)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">327</span>
                    <span class="line-content">		if ok and cdInfo then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">328</span>
                    <span class="line-content">			if type(cdInfo) == &quot;table&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">329</span>
                    <span class="line-content">				_cooldownResult.startTime = cdInfo.startTime</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">330</span>
                    <span class="line-content">				_cooldownResult.duration = cdInfo.duration</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">331</span>
                    <span class="line-content">				_cooldownResult.isEnabled = cdInfo.isEnabled</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">332</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">333</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">334</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">335</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">336</span>
                    <span class="line-content">	-- Fallback to global GetSpellCooldown</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">337</span>
                    <span class="line-content">	local hasStartTime = false</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">338</span>
                    <span class="line-content">	if IsSecret(_cooldownResult.startTime) then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">339</span>
                    <span class="line-content">		hasStartTime = true</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">340</span>
                    <span class="line-content">	elseif _cooldownResult.startTime ~= nil then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">341</span>
                    <span class="line-content">		hasStartTime = true</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">342</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">343</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">344</span>
                    <span class="line-content">	if not hasStartTime and type(GetSpellCooldown) == &quot;function&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">345</span>
                    <span class="line-content">		local ok, s, d, e = pcall(GetSpellCooldown, spellID)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">346</span>
                    <span class="line-content">		if ok then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">347</span>
                    <span class="line-content">			_cooldownResult.startTime = s</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">348</span>
                    <span class="line-content">			_cooldownResult.duration = d</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">349</span>
                    <span class="line-content">			_cooldownResult.isEnabled = e</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">350</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">351</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">352</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">353</span>
                    <span class="line-content">	-- Get charge info if requested</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">354</span>
                    <span class="line-content">	if getCharges then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">355</span>
                    <span class="line-content">		if C_Spell and type(C_Spell.GetSpellCharges) == &quot;function&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">356</span>
                    <span class="line-content">			local ok, chargeInfo = pcall(C_Spell.GetSpellCharges, spellID)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">357</span>
                    <span class="line-content">			if ok and chargeInfo and type(chargeInfo) == &quot;table&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">358</span>
                    <span class="line-content">				_cooldownResult.currentCharges = chargeInfo.currentCharges</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">359</span>
                    <span class="line-content">				_cooldownResult.maxCharges = chargeInfo.maxCharges</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">360</span>
                    <span class="line-content">				_cooldownResult.chargeStart = chargeInfo.cooldownStartTime</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">361</span>
                    <span class="line-content">				_cooldownResult.chargeDuration = chargeInfo.cooldownDuration</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">362</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">363</span>
                    <span class="line-content">		elseif type(GetSpellCharges) == &quot;function&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">364</span>
                    <span class="line-content">			local ok, cur, max, chargeStart, chargeDuration = pcall(GetSpellCharges, spellID)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">365</span>
                    <span class="line-content">			if ok and cur then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">366</span>
                    <span class="line-content">				_cooldownResult.currentCharges = cur</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">367</span>
                    <span class="line-content">				_cooldownResult.maxCharges = max</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">368</span>
                    <span class="line-content">				_cooldownResult.chargeStart = chargeStart</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">369</span>
                    <span class="line-content">				_cooldownResult.chargeDuration = chargeDuration</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">370</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">371</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">372</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">373</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">374</span>
                    <span class="line-content">	return _cooldownResult</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">375</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">376</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">377</span>
                    <span class="line-content">local function ResolveSpellInfo(token)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">378</span>
                    <span class="line-content">	if not token then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">379</span>
                    <span class="line-content">		return nil, nil</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">380</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">381</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">382</span>
                    <span class="line-content">	if C_Spell and C_Spell.GetSpellInfo then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">383</span>
                    <span class="line-content">		local ok, info = pcall(C_Spell.GetSpellInfo, token)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">384</span>
                    <span class="line-content">		if ok and info and info.spellID then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">385</span>
                    <span class="line-content">			return info.spellID, info.iconID</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">386</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">387</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">388</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">389</span>
                    <span class="line-content">	-- Fallback for older clients or transition periods</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">390</span>
                    <span class="line-content">	if type(GetSpellInfo) == &quot;function&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">391</span>
                    <span class="line-content">		local ok, _, _, icon, _, _, _, spellID = pcall(GetSpellInfo, token)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">392</span>
                    <span class="line-content">		if ok then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">393</span>
                    <span class="line-content">			return spellID or (type(token) == &quot;number&quot; and token), icon</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">394</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">395</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">396</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">397</span>
                    <span class="line-content">	return (type(token) == &quot;number&quot; and token) or nil, nil</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">398</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">399</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">400</span>
                    <span class="line-content">-- Check if player is in druid flight form (Travel Form in flying mode)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">401</span>
                    <span class="line-content">local function IsInDruidFlightForm()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">402</span>
                    <span class="line-content">	-- GetShapeshiftForm returns 3 for Travel/Aquatic/Flight Form on druids</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">403</span>
                    <span class="line-content">	-- We also need to verify we&#x27;re actually flying (not ground travel or swimming)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">404</span>
                    <span class="line-content">	if type(GetShapeshiftForm) ~= &quot;function&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">405</span>
                    <span class="line-content">		return false</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">406</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">407</span>
                    <span class="line-content">	local ok, form = pcall(GetShapeshiftForm)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">408</span>
                    <span class="line-content">	if ok and form == 3 and IsFlying() then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">409</span>
                    <span class="line-content">		return true</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">410</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">411</span>
                    <span class="line-content">	return false</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">412</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">413</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">414</span>
                    <span class="line-content">function FlightsimUI:IsSkyridingActive()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">415</span>
                    <span class="line-content">	-- Cache result for this frame to avoid repeated pcalls</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">416</span>
                    <span class="line-content">	local now = GetTime()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">417</span>
                    <span class="line-content">	if self._skyridingCacheTime == now then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">418</span>
                    <span class="line-content">		return self._skyridingCacheResult</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">419</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">420</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">421</span>
                    <span class="line-content">	-- Quick exit: if not mounted AND not in druid flight form, we&#x27;re definitely not skyriding</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">422</span>
                    <span class="line-content">	-- Druid Flight Form returns false for IsMounted() but can still do dynamic flight</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">423</span>
                    <span class="line-content">	local isMounted = IsMounted()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">424</span>
                    <span class="line-content">	local isDruidFlying = IsInDruidFlightForm()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">425</span>
                    <span class="line-content">	if not isMounted and not isDruidFlying then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">426</span>
                    <span class="line-content">		self._skyridingCacheTime = now</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">427</span>
                    <span class="line-content">		self._skyridingCacheResult = false</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">428</span>
                    <span class="line-content">		return false</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">429</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">430</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">431</span>
                    <span class="line-content">	local result = false</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">432</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">433</span>
                    <span class="line-content">	-- 1. Primary: GetGlidingInfo (The most accurate when it works)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">434</span>
                    <span class="line-content">	if C_PlayerInfo and C_PlayerInfo.GetGlidingInfo then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">435</span>
                    <span class="line-content">		local ok, isGliding, canGlide = pcall(C_PlayerInfo.GetGlidingInfo)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">436</span>
                    <span class="line-content">		if ok and (isGliding or canGlide) then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">437</span>
                    <span class="line-content">				result = true</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">438</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">439</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">440</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">441</span>
                    <span class="line-content">	-- 2. Definitive Fallback: Check for Surge Forward charges (372608)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">442</span>
                    <span class="line-content">	-- If the player has this spell with charges, they are in Skyriding mode.</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">443</span>
                    <span class="line-content">	if not result and (isMounted or isDruidFlying) then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">444</span>
                    <span class="line-content">		local surgeCharges = GetSpellCooldownSafe(372608, true)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">445</span>
                    <span class="line-content">		if surgeCharges and surgeCharges.maxCharges then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">446</span>
                    <span class="line-content">			local maxRaw = surgeCharges.maxCharges</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">447</span>
                    <span class="line-content">			local isMaxSecret = issecretvalue and issecretvalue(maxRaw)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">448</span>
                    <span class="line-content">			if not isMaxSecret and type(maxRaw) == &quot;number&quot; and maxRaw &gt; 0 then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">449</span>
                    <span class="line-content">				result = true</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">450</span>
                    <span class="line-content">			elseif isMaxSecret then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">451</span>
                    <span class="line-content">				result = true</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">452</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">453</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">454</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">455</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">456</span>
                    <span class="line-content">	-- 3. Legacy Fallbacks: check older API names</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">457</span>
                    <span class="line-content">	if not result and C_PlayerInfo and C_PlayerInfo.IsPlayerInSkyriding then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">458</span>
                    <span class="line-content">		local ok, val = pcall(C_PlayerInfo.IsPlayerInSkyriding)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">459</span>
                    <span class="line-content">		if ok and type(val) == &quot;boolean&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">460</span>
                    <span class="line-content">			result = val</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">461</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">462</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">463</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">464</span>
                    <span class="line-content">	if not result and C_PlayerInfo and C_PlayerInfo.IsPlayerInDragonriding then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">465</span>
                    <span class="line-content">		local ok, val = pcall(C_PlayerInfo.IsPlayerInDragonriding)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">466</span>
                    <span class="line-content">		if ok and type(val) == &quot;boolean&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">467</span>
                    <span class="line-content">			result = val</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">468</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">469</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">470</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">471</span>
                    <span class="line-content">	-- Cache the result</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">472</span>
                    <span class="line-content">	self._skyridingCacheTime = now</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">473</span>
                    <span class="line-content">	self._skyridingCacheResult = result</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">474</span>
                    <span class="line-content">	return result</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">475</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">476</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">477</span>
                    <span class="line-content">local function IsSecret(val)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">478</span>
                    <span class="line-content">	if val == nil then return false end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">479</span>
                    <span class="line-content">	if issecretvalue then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">480</span>
                    <span class="line-content">		return issecretvalue(val) == true</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">481</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">482</span>
                    <span class="line-content">	-- Robust fallback for secret-like objects that crash comparisons</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">483</span>
                    <span class="line-content">	local ok = pcall(function() local _ = (val &gt; -1e12) end)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">484</span>
                    <span class="line-content">	return not ok</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">485</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">486</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">487</span>
                    <span class="line-content">local function SafeCompare(a, b, op)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">488</span>
                    <span class="line-content">	if a == nil or b == nil then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">489</span>
                    <span class="line-content">		return nil</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">490</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">491</span>
                    <span class="line-content">	if IsSecret(a) or IsSecret(b) then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">492</span>
                    <span class="line-content">		return nil</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">493</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">494</span>
                    <span class="line-content">	if op == &quot;&gt;&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">495</span>
                    <span class="line-content">		return a &gt; b</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">496</span>
                    <span class="line-content">	elseif op == &quot;&lt;&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">497</span>
                    <span class="line-content">		return a &lt; b</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">498</span>
                    <span class="line-content">	elseif op == &quot;&gt;=&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">499</span>
                    <span class="line-content">		return a &gt;= b</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">500</span>
                    <span class="line-content">	elseif op == &quot;&lt;=&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">501</span>
                    <span class="line-content">		return a &lt;= b</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">502</span>
                    <span class="line-content">	elseif op == &quot;==&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">503</span>
                    <span class="line-content">		return a == b</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">504</span>
                    <span class="line-content">	elseif op == &quot;~=&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">505</span>
                    <span class="line-content">		return a ~= b</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">506</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">507</span>
                    <span class="line-content">	return nil</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">508</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">509</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">510</span>
                    <span class="line-content">function FlightsimUI:Init(db)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">511</span>
                    <span class="line-content">	self.db = db</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">512</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">513</span>
                    <span class="line-content">	-- Minimal UI: the frame *is* the speed bar.</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">514</span>
                    <span class="line-content">	local frame = CreateFrame(&quot;StatusBar&quot;, &quot;FlightsimFrame&quot;, UIParent)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">515</span>
                    <span class="line-content">	self.frame = frame</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">516</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">517</span>
                    <span class="line-content">	frame:SetSize(150, 40)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">518</span>
                    <span class="line-content">	frame:SetScale(db.profile.scale or 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">519</span>
                    <span class="line-content">	frame:SetPoint(&quot;CENTER&quot;, UIParent, &quot;CENTER&quot;, db.profile.x or 0, db.profile.y or 0)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">520</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">521</span>
                    <span class="line-content">	frame:SetStatusBarTexture(&quot;Interface/Buttons/WHITE8X8&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">522</span>
                    <span class="line-content">	frame:SetMinMaxValues(0, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">523</span>
                    <span class="line-content">	frame:SetValue(0)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">524</span>
                    <span class="line-content">	self.speedBar = frame</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">525</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">526</span>
                    <span class="line-content">	frame:EnableMouse(true)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">527</span>
                    <span class="line-content">	frame:SetMovable(true)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">528</span>
                    <span class="line-content">	frame:RegisterForDrag(&quot;LeftButton&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">529</span>
                    <span class="line-content">	frame:SetScript(&quot;OnDragStart&quot;, function()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">530</span>
                    <span class="line-content">		if not (self.db and self.db.profile and self.db.profile.locked) then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">531</span>
                    <span class="line-content">			frame:StartMoving()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">532</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">533</span>
                    <span class="line-content">	end)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">534</span>
                    <span class="line-content">	frame:SetScript(&quot;OnDragStop&quot;, function()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">535</span>
                    <span class="line-content">		frame:StopMovingOrSizing()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">536</span>
                    <span class="line-content">		local _, _, _, x, y = frame:GetPoint(1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">537</span>
                    <span class="line-content">		self.db.profile.x = x</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">538</span>
                    <span class="line-content">		self.db.profile.y = y</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">539</span>
                    <span class="line-content">	end)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">540</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">541</span>
                    <span class="line-content">	-- Event hooks for skyriding state (zone changes).</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">542</span>
                    <span class="line-content">	local events = CreateFrame(&quot;Frame&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">543</span>
                    <span class="line-content">	self._eventFrame = events</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">544</span>
                    <span class="line-content">	events:RegisterEvent(&quot;PLAYER_ENTERING_WORLD&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">545</span>
                    <span class="line-content">	events:RegisterEvent(&quot;ZONE_CHANGED_NEW_AREA&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">546</span>
                    <span class="line-content">	events:SetScript(&quot;OnEvent&quot;, function(_, event, ...)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">547</span>
                    <span class="line-content">		-- Zone-related state refresh</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">548</span>
                    <span class="line-content">		self._isSlowSkyriding = IsSlowSkyridingZone()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">549</span>
                    <span class="line-content">	end)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">550</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">551</span>
                    <span class="line-content">	local barBg = frame:CreateTexture(nil, &quot;BACKGROUND&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">552</span>
                    <span class="line-content">	barBg:SetAllPoints(frame)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">553</span>
                    <span class="line-content">	-- Flat dark background.</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">554</span>
                    <span class="line-content">	barBg:SetColorTexture(0.08, 0.12, 0.18, 0.85)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">555</span>
                    <span class="line-content">	self.speedBarBg = barBg</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">556</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">557</span>
                    <span class="line-content">	-- Create an overlay frame on top of the StatusBar for text and marker</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">558</span>
                    <span class="line-content">	-- This ensures they render above the StatusBar fill texture</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">559</span>
                    <span class="line-content">	local overlay = CreateFrame(&quot;Frame&quot;, nil, frame)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">560</span>
                    <span class="line-content">	overlay:SetAllPoints(frame)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">561</span>
                    <span class="line-content">	overlay:SetFrameLevel(frame:GetFrameLevel() + 10)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">562</span>
                    <span class="line-content">	self.speedBarOverlay = overlay</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">563</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">564</span>
                    <span class="line-content">	-- Sustainable speed marker - parented to overlay frame</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">565</span>
                    <span class="line-content">	local sustainableMarkerWidth = (db.profile.ui and db.profile.ui.sustainableSpeedMarkerWidth)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">566</span>
                    <span class="line-content">		or (db.profile.ui and db.profile.ui.optimalMarkerWidth)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">567</span>
                    <span class="line-content">		or 1</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">568</span>
                    <span class="line-content">	local sustainableMarkerAlpha = (db.profile.ui and db.profile.ui.sustainableSpeedMarkerAlpha) or 0.2</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">569</span>
                    <span class="line-content">	local optimal = overlay:CreateTexture(nil, &quot;OVERLAY&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">570</span>
                    <span class="line-content">	optimal:SetColorTexture(1, 1, 1, sustainableMarkerAlpha)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">571</span>
                    <span class="line-content">	optimal:SetWidth(sustainableMarkerWidth)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">572</span>
                    <span class="line-content">	optimal:SetPoint(&quot;TOP&quot;, overlay, &quot;TOP&quot;, 0, 0)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">573</span>
                    <span class="line-content">	optimal:SetPoint(&quot;BOTTOM&quot;, overlay, &quot;BOTTOM&quot;, 0, 0)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">574</span>
                    <span class="line-content">	self.sustainableMarker = optimal</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">575</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">576</span>
                    <span class="line-content">	-- Speed text - parented to overlay frame</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">577</span>
                    <span class="line-content">	local speedText = overlay:CreateFontString(nil, &quot;OVERLAY&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">578</span>
                    <span class="line-content">	-- Sans-serif look like WA.</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">579</span>
                    <span class="line-content">	local fontSize = (db.profile.speedBar and db.profile.speedBar.fontSize) or 12</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">580</span>
                    <span class="line-content">	speedText:SetFont(&quot;Fonts\\ARIALN.TTF&quot;, fontSize, &quot;OUTLINE&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">581</span>
                    <span class="line-content">	speedText:SetPoint(&quot;LEFT&quot;, overlay, &quot;LEFT&quot;, 6, 0)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">582</span>
                    <span class="line-content">	speedText:SetJustifyH(&quot;LEFT&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">583</span>
                    <span class="line-content">	speedText:SetText(&quot;0%&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">584</span>
                    <span class="line-content">	self.speedText = speedText</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">585</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">586</span>
                    <span class="line-content">	-- Acceleration bar (below the speed bar)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">587</span>
                    <span class="line-content">	local accelBarHeight = (db.profile.ui and db.profile.ui.accelBarHeight) or 2</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">588</span>
                    <span class="line-content">	local accelGap = (db.profile.ui and db.profile.ui.accelBarGap) or 2</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">589</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">590</span>
                    <span class="line-content">	local accelFrame = CreateFrame(&quot;Frame&quot;, nil, UIParent)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">591</span>
                    <span class="line-content">	accelFrame:SetSize(db.profile.ui.width or 150, accelBarHeight)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">592</span>
                    <span class="line-content">	accelFrame:SetPoint(&quot;TOP&quot;, frame, &quot;BOTTOM&quot;, 0, -accelGap)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">593</span>
                    <span class="line-content">	self.accelFrame = accelFrame</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">594</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">595</span>
                    <span class="line-content">	local accelBg = accelFrame:CreateTexture(nil, &quot;BACKGROUND&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">596</span>
                    <span class="line-content">	accelBg:SetAllPoints(accelFrame)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">597</span>
                    <span class="line-content">	accelBg:SetColorTexture(0.08, 0.12, 0.18, 0.85)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">598</span>
                    <span class="line-content">	self.accelBarBg = accelBg</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">599</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">600</span>
                    <span class="line-content">	-- No center marker - the bar itself indicates state</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">601</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">602</span>
                    <span class="line-content">	-- The actual acceleration indicator bar (starts from center, white)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">603</span>
                    <span class="line-content">	local accelBar = accelFrame:CreateTexture(nil, &quot;ARTWORK&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">604</span>
                    <span class="line-content">	accelBar:SetColorTexture(1, 1, 1, 0.9) -- White</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">605</span>
                    <span class="line-content">	accelBar:SetHeight(accelBarHeight)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">606</span>
                    <span class="line-content">	self.accelBar = accelBar</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">607</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">608</span>
                    <span class="line-content">	-- Ability bars (below the acceleration bar)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">609</span>
                    <span class="line-content">	-- Order: Surge Forward -&gt; Second Wind -&gt; Whirling Surge</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">610</span>
                    <span class="line-content">	local abilityBarHeight = (db.profile.ui and db.profile.ui.abilityBarHeight) or 10</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">611</span>
                    <span class="line-content">	local barGap = (db.profile.ui and db.profile.ui.barGap) or 2</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">612</span>
                    <span class="line-content">	local chargeGap = 2 -- Gap between charge bars within a multi-charge ability</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">613</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">614</span>
                    <span class="line-content">	-- Surge Forward charge bars (6 charges, light blue #74AFFF)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">615</span>
                    <span class="line-content">	local surgeForwardFrame = CreateFrame(&quot;Frame&quot;, nil, UIParent)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">616</span>
                    <span class="line-content">	surgeForwardFrame:SetSize(db.profile.ui.width or 150, abilityBarHeight)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">617</span>
                    <span class="line-content">	surgeForwardFrame:SetPoint(&quot;TOP&quot;, accelFrame, &quot;BOTTOM&quot;, 0, -barGap)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">618</span>
                    <span class="line-content">	self.surgeForwardFrame = surgeForwardFrame</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">619</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">620</span>
                    <span class="line-content">	self.surgeForwardBars = {}</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">621</span>
                    <span class="line-content">	self.surgeForwardBarBgs = {}</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">622</span>
                    <span class="line-content">	local sfTotalGaps = chargeGap * 5 -- 5 gaps between 6 bars</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">623</span>
                    <span class="line-content">	local sfChargeWidth = ((db.profile.ui.width or 150) - sfTotalGaps) / 6</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">624</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">625</span>
                    <span class="line-content">	for i = 1, 6 do</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">626</span>
                    <span class="line-content">		local chargeBar = CreateFrame(&quot;StatusBar&quot;, nil, surgeForwardFrame)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">627</span>
                    <span class="line-content">		chargeBar:SetSize(sfChargeWidth, abilityBarHeight)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">628</span>
                    <span class="line-content">		chargeBar:SetStatusBarTexture(&quot;Interface/Buttons/WHITE8X8&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">629</span>
                    <span class="line-content">		chargeBar:SetMinMaxValues(0, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">630</span>
                    <span class="line-content">		chargeBar:SetValue(1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">631</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">632</span>
                    <span class="line-content">		local chargeBg = chargeBar:CreateTexture(nil, &quot;BACKGROUND&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">633</span>
                    <span class="line-content">		chargeBg:SetAllPoints(chargeBar)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">634</span>
                    <span class="line-content">		chargeBg:SetColorTexture(0.08, 0.12, 0.18, 0.85)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">635</span>
                    <span class="line-content">		self.surgeForwardBarBgs[i] = chargeBg</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">636</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">637</span>
                    <span class="line-content">		if i == 1 then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">638</span>
                    <span class="line-content">			chargeBar:SetPoint(&quot;LEFT&quot;, surgeForwardFrame, &quot;LEFT&quot;, 0, 0)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">639</span>
                    <span class="line-content">		else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">640</span>
                    <span class="line-content">			chargeBar:SetPoint(&quot;LEFT&quot;, self.surgeForwardBars[i - 1], &quot;RIGHT&quot;, chargeGap, 0)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">641</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">642</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">643</span>
                    <span class="line-content">		self.surgeForwardBars[i] = chargeBar</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">644</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">645</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">646</span>
                    <span class="line-content">	-- Second Wind charge bars (3 charges, purple #D379EF)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">647</span>
                    <span class="line-content">	local secondWindFrame = CreateFrame(&quot;Frame&quot;, nil, UIParent)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">648</span>
                    <span class="line-content">	secondWindFrame:SetSize(db.profile.ui.width or 150, abilityBarHeight)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">649</span>
                    <span class="line-content">	secondWindFrame:SetPoint(&quot;TOP&quot;, surgeForwardFrame, &quot;BOTTOM&quot;, 0, -barGap)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">650</span>
                    <span class="line-content">	self.secondWindFrame = secondWindFrame</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">651</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">652</span>
                    <span class="line-content">	self.secondWindBars = {}</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">653</span>
                    <span class="line-content">	self.secondWindBarBgs = {}</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">654</span>
                    <span class="line-content">	local swTotalGaps = chargeGap * 2 -- 2 gaps between 3 bars</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">655</span>
                    <span class="line-content">	local swChargeWidth = ((db.profile.ui.width or 150) - swTotalGaps) / 3</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">656</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">657</span>
                    <span class="line-content">	for i = 1, 3 do</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">658</span>
                    <span class="line-content">		local chargeBar = CreateFrame(&quot;StatusBar&quot;, nil, secondWindFrame)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">659</span>
                    <span class="line-content">		chargeBar:SetSize(swChargeWidth, abilityBarHeight)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">660</span>
                    <span class="line-content">		chargeBar:SetStatusBarTexture(&quot;Interface/Buttons/WHITE8X8&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">661</span>
                    <span class="line-content">		chargeBar:SetMinMaxValues(0, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">662</span>
                    <span class="line-content">		chargeBar:SetValue(1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">663</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">664</span>
                    <span class="line-content">		local chargeBg = chargeBar:CreateTexture(nil, &quot;BACKGROUND&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">665</span>
                    <span class="line-content">		chargeBg:SetAllPoints(chargeBar)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">666</span>
                    <span class="line-content">		chargeBg:SetColorTexture(0.08, 0.12, 0.18, 0.85)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">667</span>
                    <span class="line-content">		self.secondWindBarBgs[i] = chargeBg</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">668</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">669</span>
                    <span class="line-content">		if i == 1 then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">670</span>
                    <span class="line-content">			chargeBar:SetPoint(&quot;LEFT&quot;, secondWindFrame, &quot;LEFT&quot;, 0, 0)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">671</span>
                    <span class="line-content">		else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">672</span>
                    <span class="line-content">			chargeBar:SetPoint(&quot;LEFT&quot;, self.secondWindBars[i - 1], &quot;RIGHT&quot;, chargeGap, 0)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">673</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">674</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">675</span>
                    <span class="line-content">		self.secondWindBars[i] = chargeBar</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">676</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">677</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">678</span>
                    <span class="line-content">	-- Whirling Surge cooldown bar (30s cooldown, cyan #4AC7D4)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">679</span>
                    <span class="line-content">	local whirlingSurgeFrame = CreateFrame(&quot;StatusBar&quot;, nil, UIParent)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">680</span>
                    <span class="line-content">	whirlingSurgeFrame:SetSize(db.profile.ui.width or 150, abilityBarHeight)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">681</span>
                    <span class="line-content">	whirlingSurgeFrame:SetPoint(&quot;TOP&quot;, secondWindFrame, &quot;BOTTOM&quot;, 0, -barGap)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">682</span>
                    <span class="line-content">	whirlingSurgeFrame:SetStatusBarTexture(&quot;Interface/Buttons/WHITE8X8&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">683</span>
                    <span class="line-content">	whirlingSurgeFrame:SetMinMaxValues(0, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">684</span>
                    <span class="line-content">	whirlingSurgeFrame:SetValue(1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">685</span>
                    <span class="line-content">	self.whirlingSurgeBar = whirlingSurgeFrame</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">686</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">687</span>
                    <span class="line-content">	local whirlingSurgeBg = whirlingSurgeFrame:CreateTexture(nil, &quot;BACKGROUND&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">688</span>
                    <span class="line-content">	whirlingSurgeBg:SetAllPoints(whirlingSurgeFrame)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">689</span>
                    <span class="line-content">	whirlingSurgeBg:SetColorTexture(0.08, 0.12, 0.18, 0.85)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">690</span>
                    <span class="line-content">	self.whirlingSurgeBg = whirlingSurgeBg</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">691</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">692</span>
                    <span class="line-content">	-- Animation state tracking</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">693</span>
                    <span class="line-content">	self._surgeForwardAnimating = { false, false, false, false, false, false }</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">694</span>
                    <span class="line-content">	self._surgeForwardAnimValue = { 1, 1, 1, 1, 1, 1 }</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">695</span>
                    <span class="line-content">	self._surgeForwardLastTarget = {}</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">696</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">697</span>
                    <span class="line-content">	self._secondWindAnimating = { false, false, false }</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">698</span>
                    <span class="line-content">	self._secondWindAnimValue = { 1, 1, 1 }</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">699</span>
                    <span class="line-content">	self._secondWindLastTarget = {}</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">700</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">701</span>
                    <span class="line-content">	self._whirlingSurgeAnimating = false</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">702</span>
                    <span class="line-content">	self._whirlingSurgeAnimValue = 1</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">703</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">704</span>
                    <span class="line-content">	self:RebuildLayout()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">705</span>
                    <span class="line-content">	self:StartUpdating()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">706</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">707</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">708</span>
                    <span class="line-content">function FlightsimUI:RebuildLayout()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">709</span>
                    <span class="line-content">	if not (self.frame and self.db and self.db.profile) then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">710</span>
                    <span class="line-content">		return</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">711</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">712</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">713</span>
                    <span class="line-content">	local p = self.db.profile</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">714</span>
                    <span class="line-content">	local ui = p.ui or {}</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">715</span>
                    <span class="line-content">	local ab = p.abilityBars or {}</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">716</span>
                    <span class="line-content">	local scale = p.scale or 1</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">717</span>
                    <span class="line-content">	local width = ui.width or 150</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">718</span>
                    <span class="line-content">	local barH = ui.speedBarHeight or 20</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">719</span>
                    <span class="line-content">	local accelH = ui.accelBarHeight or 1</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">720</span>
                    <span class="line-content">	local accelGap = ui.accelBarGap or 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">721</span>
                    <span class="line-content">	local barGap = ui.barGap or 2</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">722</span>
                    <span class="line-content">	local sustainableW = ui.sustainableSpeedMarkerWidth or ui.optimalMarkerWidth or 1</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">723</span>
                    <span class="line-content">	local sustainableAlpha = ui.sustainableSpeedMarkerAlpha or 0.2</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">724</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">725</span>
                    <span class="line-content">	-- Ability bar visibility settings</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">726</span>
                    <span class="line-content">	local showSurgeForward = ab.showSurgeForward ~= false</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">727</span>
                    <span class="line-content">	local showSecondWind = ab.showSecondWind ~= false</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">728</span>
                    <span class="line-content">	local showWhirlingSurge = ab.showWhirlingSurge ~= false</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">729</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">730</span>
                    <span class="line-content">	-- Apply scale to all frames</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">731</span>
                    <span class="line-content">	self.frame:SetScale(scale)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">732</span>
                    <span class="line-content">	if self.accelFrame then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">733</span>
                    <span class="line-content">		self.accelFrame:SetScale(scale)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">734</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">735</span>
                    <span class="line-content">	if self.surgeForwardFrame then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">736</span>
                    <span class="line-content">		self.surgeForwardFrame:SetScale(scale)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">737</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">738</span>
                    <span class="line-content">	if self.secondWindFrame then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">739</span>
                    <span class="line-content">		self.secondWindFrame:SetScale(scale)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">740</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">741</span>
                    <span class="line-content">	if self.whirlingSurgeBar then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">742</span>
                    <span class="line-content">		self.whirlingSurgeBar:SetScale(scale)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">743</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">744</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">745</span>
                    <span class="line-content">	self.frame:SetSize(width, barH)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">746</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">747</span>
                    <span class="line-content">	-- Update sustainable speed marker width and alpha</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">748</span>
                    <span class="line-content">	if self.sustainableMarker then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">749</span>
                    <span class="line-content">		self.sustainableMarker:SetWidth(sustainableW)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">750</span>
                    <span class="line-content">		self.sustainableMarker:SetColorTexture(1, 1, 1, sustainableAlpha)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">751</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">752</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">753</span>
                    <span class="line-content">	-- Update acceleration bar dimensions</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">754</span>
                    <span class="line-content">	if self.accelFrame then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">755</span>
                    <span class="line-content">		self.accelFrame:SetSize(width, accelH)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">756</span>
                    <span class="line-content">		self.accelFrame:ClearAllPoints()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">757</span>
                    <span class="line-content">		self.accelFrame:SetPoint(&quot;TOP&quot;, self.frame, &quot;BOTTOM&quot;, 0, -accelGap)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">758</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">759</span>
                    <span class="line-content">	if self.accelBar then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">760</span>
                    <span class="line-content">		self.accelBar:SetHeight(accelH)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">761</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">762</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">763</span>
                    <span class="line-content">	-- Update ability bar dimensions</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">764</span>
                    <span class="line-content">	-- Order: Surge Forward -&gt; Second Wind -&gt; Whirling Surge</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">765</span>
                    <span class="line-content">	-- Bars anchor to the previous visible bar</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">766</span>
                    <span class="line-content">	local abilityH = ui.abilityBarHeight or 10</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">767</span>
                    <span class="line-content">	local chargeGap = 2</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">768</span>
                    <span class="line-content">	local lastAnchor = self.accelFrame</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">769</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">770</span>
                    <span class="line-content">	-- Surge Forward (6 charges)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">771</span>
                    <span class="line-content">	if self.surgeForwardFrame then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">772</span>
                    <span class="line-content">		if showSurgeForward then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">773</span>
                    <span class="line-content">			self.surgeForwardFrame:SetSize(width, abilityH)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">774</span>
                    <span class="line-content">			self.surgeForwardFrame:ClearAllPoints()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">775</span>
                    <span class="line-content">			self.surgeForwardFrame:SetPoint(&quot;TOP&quot;, lastAnchor, &quot;BOTTOM&quot;, 0, -barGap)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">776</span>
                    <span class="line-content">			self.surgeForwardFrame:Show()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">777</span>
                    <span class="line-content">			lastAnchor = self.surgeForwardFrame</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">778</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">779</span>
                    <span class="line-content">			local sfTotalGaps = chargeGap * 5</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">780</span>
                    <span class="line-content">			local sfChargeWidth = (width - sfTotalGaps) / 6</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">781</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">782</span>
                    <span class="line-content">			if self.surgeForwardBars then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">783</span>
                    <span class="line-content">				for i, chargeBar in ipairs(self.surgeForwardBars) do</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">784</span>
                    <span class="line-content">					chargeBar:SetSize(sfChargeWidth, abilityH)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">785</span>
                    <span class="line-content">					chargeBar:ClearAllPoints()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">786</span>
                    <span class="line-content">					if i == 1 then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">787</span>
                    <span class="line-content">						chargeBar:SetPoint(&quot;LEFT&quot;, self.surgeForwardFrame, &quot;LEFT&quot;, 0, 0)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">788</span>
                    <span class="line-content">					else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">789</span>
                    <span class="line-content">						chargeBar:SetPoint(&quot;LEFT&quot;, self.surgeForwardBars[i - 1], &quot;RIGHT&quot;, chargeGap, 0)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">790</span>
                    <span class="line-content">					end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">791</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">792</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">793</span>
                    <span class="line-content">		else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">794</span>
                    <span class="line-content">			self.surgeForwardFrame:Hide()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">795</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">796</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">797</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">798</span>
                    <span class="line-content">	-- Second Wind (3 charges)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">799</span>
                    <span class="line-content">	if self.secondWindFrame then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">800</span>
                    <span class="line-content">		if showSecondWind then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">801</span>
                    <span class="line-content">			self.secondWindFrame:SetSize(width, abilityH)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">802</span>
                    <span class="line-content">			self.secondWindFrame:ClearAllPoints()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">803</span>
                    <span class="line-content">			self.secondWindFrame:SetPoint(&quot;TOP&quot;, lastAnchor, &quot;BOTTOM&quot;, 0, -barGap)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">804</span>
                    <span class="line-content">			self.secondWindFrame:Show()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">805</span>
                    <span class="line-content">			lastAnchor = self.secondWindFrame</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">806</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">807</span>
                    <span class="line-content">			local swTotalGaps = chargeGap * 2</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">808</span>
                    <span class="line-content">			local swChargeWidth = (width - swTotalGaps) / 3</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">809</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">810</span>
                    <span class="line-content">			if self.secondWindBars then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">811</span>
                    <span class="line-content">				for i, chargeBar in ipairs(self.secondWindBars) do</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">812</span>
                    <span class="line-content">					chargeBar:SetSize(swChargeWidth, abilityH)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">813</span>
                    <span class="line-content">					chargeBar:ClearAllPoints()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">814</span>
                    <span class="line-content">					if i == 1 then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">815</span>
                    <span class="line-content">						chargeBar:SetPoint(&quot;LEFT&quot;, self.secondWindFrame, &quot;LEFT&quot;, 0, 0)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">816</span>
                    <span class="line-content">					else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">817</span>
                    <span class="line-content">						chargeBar:SetPoint(&quot;LEFT&quot;, self.secondWindBars[i - 1], &quot;RIGHT&quot;, chargeGap, 0)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">818</span>
                    <span class="line-content">					end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">819</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">820</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">821</span>
                    <span class="line-content">		else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">822</span>
                    <span class="line-content">			self.secondWindFrame:Hide()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">823</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">824</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">825</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">826</span>
                    <span class="line-content">	-- Whirling Surge (cooldown bar)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">827</span>
                    <span class="line-content">	if self.whirlingSurgeBar then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">828</span>
                    <span class="line-content">		if showWhirlingSurge then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">829</span>
                    <span class="line-content">			self.whirlingSurgeBar:SetSize(width, abilityH)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">830</span>
                    <span class="line-content">			self.whirlingSurgeBar:ClearAllPoints()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">831</span>
                    <span class="line-content">			self.whirlingSurgeBar:SetPoint(&quot;TOP&quot;, lastAnchor, &quot;BOTTOM&quot;, 0, -barGap)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">832</span>
                    <span class="line-content">			self.whirlingSurgeBar:Show()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">833</span>
                    <span class="line-content">		else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">834</span>
                    <span class="line-content">			self.whirlingSurgeBar:Hide()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">835</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">836</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">837</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">838</span>
                    <span class="line-content">	-- Always re-apply visibility after layout changes</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">839</span>
                    <span class="line-content">	self:ApplyVisibility()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">840</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">841</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">842</span>
                    <span class="line-content">function FlightsimUI:ApplyVisibility()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">843</span>
                    <span class="line-content">	if not (self.frame and self.db and self.db.profile and self.db.profile.visibility) then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">844</span>
                    <span class="line-content">		return</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">845</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">846</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">847</span>
                    <span class="line-content">	-- Wrap visibility logic in pcall to handle API instability during flight mode transitions</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">848</span>
                    <span class="line-content">	local ok, err = pcall(function()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">849</span>
                    <span class="line-content">		local v = self.db.profile.visibility</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">850</span>
                    <span class="line-content">		local ab = self.db.profile.abilityBars or {}</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">851</span>
                    <span class="line-content">		local skyriding = self:IsSkyridingActive()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">852</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">853</span>
                    <span class="line-content">		local shouldShow = true</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">854</span>
                    <span class="line-content">		if v.hideWhenNotSkyriding and not skyriding then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">855</span>
                    <span class="line-content">			shouldShow = false</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">856</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">857</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">858</span>
                    <span class="line-content">		if shouldShow then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">859</span>
                    <span class="line-content">			if not self.frame:IsShown() then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">860</span>
                    <span class="line-content">				self.frame:Show()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">861</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">862</span>
                    <span class="line-content">			self.frame:SetAlpha(1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">863</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">864</span>
                    <span class="line-content">			if self.accelFrame and not self.accelFrame:IsShown() then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">865</span>
                    <span class="line-content">				self.accelFrame:Show()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">866</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">867</span>
                    <span class="line-content">			if self.accelFrame then self.accelFrame:SetAlpha(1) end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">868</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">869</span>
                    <span class="line-content">			-- Respect individual ability bar settings</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">870</span>
                    <span class="line-content">			if self.surgeForwardFrame and ab.showSurgeForward ~= false then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">871</span>
                    <span class="line-content">				if not self.surgeForwardFrame:IsShown() then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">872</span>
                    <span class="line-content">					self.surgeForwardFrame:Show()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">873</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">874</span>
                    <span class="line-content">				self.surgeForwardFrame:SetAlpha(1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">875</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">876</span>
                    <span class="line-content">			if self.secondWindFrame and ab.showSecondWind ~= false then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">877</span>
                    <span class="line-content">				if not self.secondWindFrame:IsShown() then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">878</span>
                    <span class="line-content">					self.secondWindFrame:Show()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">879</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">880</span>
                    <span class="line-content">				self.secondWindFrame:SetAlpha(1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">881</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">882</span>
                    <span class="line-content">			if self.whirlingSurgeBar and ab.showWhirlingSurge ~= false then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">883</span>
                    <span class="line-content">				if not self.whirlingSurgeBar:IsShown() then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">884</span>
                    <span class="line-content">					self.whirlingSurgeBar:Show()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">885</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">886</span>
                    <span class="line-content">				self.whirlingSurgeBar:SetAlpha(1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">887</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">888</span>
                    <span class="line-content">		else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">889</span>
                    <span class="line-content">			if self.frame:IsShown() then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">890</span>
                    <span class="line-content">				self.frame:Hide()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">891</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">892</span>
                    <span class="line-content">			if self.accelFrame and self.accelFrame:IsShown() then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">893</span>
                    <span class="line-content">				self.accelFrame:Hide()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">894</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">895</span>
                    <span class="line-content">			if self.surgeForwardFrame and self.surgeForwardFrame:IsShown() then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">896</span>
                    <span class="line-content">				self.surgeForwardFrame:Hide()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">897</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">898</span>
                    <span class="line-content">			if self.secondWindFrame and self.secondWindFrame:IsShown() then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">899</span>
                    <span class="line-content">				self.secondWindFrame:Hide()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">900</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">901</span>
                    <span class="line-content">			if self.whirlingSurgeBar and self.whirlingSurgeBar:IsShown() then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">902</span>
                    <span class="line-content">				self.whirlingSurgeBar:Hide()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">903</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">904</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">905</span>
                    <span class="line-content">	end)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">906</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">907</span>
                    <span class="line-content">	if not ok and self.db.profile.debug then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">908</span>
                    <span class="line-content">		-- Only log if debug is enabled to avoid spamming the user</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">909</span>
                    <span class="line-content">		local L = Flightsim.L</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">910</span>
                    <span class="line-content">		print(L[&quot;VISIBILITY_ERROR&quot;] .. tostring(err))</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">911</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">912</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">913</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">914</span>
                    <span class="line-content">function FlightsimUI:_GetFallbackSpeedFromPosition(elapsed)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">915</span>
                    <span class="line-content">	if type(UnitPosition) ~= &quot;function&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">916</span>
                    <span class="line-content">		return 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">917</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">918</span>
                    <span class="line-content">	local now = (GetTimePreciseSec and GetTimePreciseSec()) or GetTime()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">919</span>
                    <span class="line-content">	local x, y, z, instanceID = UnitPosition(&quot;player&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">920</span>
                    <span class="line-content">	if not (x and y and z and instanceID) then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">921</span>
                    <span class="line-content">		return 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">922</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">923</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">924</span>
                    <span class="line-content">	local last = self._lastPos</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">925</span>
                    <span class="line-content">	-- Reuse the table to avoid per-frame allocation</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">926</span>
                    <span class="line-content">	if not last then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">927</span>
                    <span class="line-content">		self._lastPos = { t = now, x = x, y = y, z = z, instanceID = instanceID }</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">928</span>
                    <span class="line-content">		return 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">929</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">930</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">931</span>
                    <span class="line-content">	if last.instanceID ~= instanceID then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">932</span>
                    <span class="line-content">		last.t, last.x, last.y, last.z, last.instanceID = now, x, y, z, instanceID</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">933</span>
                    <span class="line-content">		return 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">934</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">935</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">936</span>
                    <span class="line-content">	local dt = now - (last.t or now)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">937</span>
                    <span class="line-content">	if not dt or dt &lt;= 0 then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">938</span>
                    <span class="line-content">		last.t, last.x, last.y, last.z = now, x, y, z</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">939</span>
                    <span class="line-content">		return 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">940</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">941</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">942</span>
                    <span class="line-content">	local dx = x - (last.x or x)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">943</span>
                    <span class="line-content">	local dy = y - (last.y or y)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">944</span>
                    <span class="line-content">	local dz = z - (last.z or z)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">945</span>
                    <span class="line-content">	local dist = math.sqrt((dx * dx) + (dy * dy) + (dz * dz))</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">946</span>
                    <span class="line-content">	local speed = dist / dt</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">947</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">948</span>
                    <span class="line-content">	-- Update stored position (reuse table)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">949</span>
                    <span class="line-content">	last.t, last.x, last.y, last.z = now, x, y, z</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">950</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">951</span>
                    <span class="line-content">	if speed ~= speed or speed == math.huge then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">952</span>
                    <span class="line-content">		return 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">953</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">954</span>
                    <span class="line-content">	return speed</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">955</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">956</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">957</span>
                    <span class="line-content">function FlightsimUI:StartUpdating()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">958</span>
                    <span class="line-content">	if not self.frame then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">959</span>
                    <span class="line-content">		return</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">960</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">961</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">962</span>
                    <span class="line-content">	-- Create a separate ticker frame that&#x27;s always shown (never hidden)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">963</span>
                    <span class="line-content">	-- This ensures ApplyVisibility keeps running even when main frame is hidden</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">964</span>
                    <span class="line-content">	if not self.tickerFrame then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">965</span>
                    <span class="line-content">		self.tickerFrame = CreateFrame(&quot;Frame&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">966</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">967</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">968</span>
                    <span class="line-content">	-- Register for mount events to reduce polling when not skyriding</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">969</span>
                    <span class="line-content">	if not self._eventsRegistered then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">970</span>
                    <span class="line-content">		self._eventsRegistered = true</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">971</span>
                    <span class="line-content">		self.tickerFrame:RegisterEvent(&quot;PLAYER_MOUNT_DISPLAY_CHANGED&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">972</span>
                    <span class="line-content">		self.tickerFrame:RegisterEvent(&quot;UNIT_AURA&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">973</span>
                    <span class="line-content">		self.tickerFrame:RegisterEvent(&quot;PLAYER_ENTERING_WORLD&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">974</span>
                    <span class="line-content">		self.tickerFrame:RegisterEvent(&quot;UPDATE_SHAPESHIFT_FORMS&quot;) -- For druid flight form</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">975</span>
                    <span class="line-content">		self.tickerFrame:SetScript(&quot;OnEvent&quot;, function(_, event, unit)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">976</span>
                    <span class="line-content">			if event == &quot;UNIT_AURA&quot; and unit ~= &quot;player&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">977</span>
                    <span class="line-content">				return</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">978</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">979</span>
                    <span class="line-content">			-- Force visibility check on mount change and invalidate cache</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">980</span>
                    <span class="line-content">			self._forceVisibilityCheck = true</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">981</span>
                    <span class="line-content">			self._skyridingCacheTime = nil -- Invalidate cache immediately</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">982</span>
                    <span class="line-content">		end)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">983</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">984</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">985</span>
                    <span class="line-content">	self.tickerFrame:SetScript(&quot;OnUpdate&quot;, function(_, elapsed) -- luacheck: ignore</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">986</span>
                    <span class="line-content">		self._accum = (self._accum or 0) + elapsed</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">987</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">988</span>
                    <span class="line-content">		-- Adaptive throttling:</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">989</span>
                    <span class="line-content">		-- - When visible/skyriding: 20Hz (0.05s) for smooth updates</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">990</span>
                    <span class="line-content">		-- - When hidden: 2Hz (0.5s) to save CPU while staying responsive</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">991</span>
                    <span class="line-content">		local isVisible = self.frame:IsShown()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">992</span>
                    <span class="line-content">		local throttle = isVisible and 0.05 or 0.5</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">993</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">994</span>
                    <span class="line-content">		if not self._forceVisibilityCheck and self._accum &lt; throttle then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">995</span>
                    <span class="line-content">			return</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">996</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">997</span>
                    <span class="line-content">		self._accum = 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">998</span>
                    <span class="line-content">		self._forceVisibilityCheck = false</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">999</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1000</span>
                    <span class="line-content">		-- Quick exit for unmounted state - no need to call ApplyVisibility</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1001</span>
                    <span class="line-content">		-- which does expensive IsSkyridingActive() check</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1002</span>
                    <span class="line-content">		-- Note: Druids in Flight Form have IsMounted()=false (it&#x27;s a shapeshift, not a mount)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1003</span>
                    <span class="line-content">		local mounted = IsMounted()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1004</span>
                    <span class="line-content">		local druidFlying = IsInDruidFlightForm()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1005</span>
                    <span class="line-content">		if</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1006</span>
                    <span class="line-content">			not mounted</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1007</span>
                    <span class="line-content">			and not druidFlying</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1008</span>
                    <span class="line-content">			and self.db</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1009</span>
                    <span class="line-content">			and self.db.profile</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1010</span>
                    <span class="line-content">			and self.db.profile.visibility</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1011</span>
                    <span class="line-content">			and self.db.profile.visibility.hideWhenNotSkyriding</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1012</span>
                    <span class="line-content">		then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1013</span>
                    <span class="line-content">			-- Force hide when not mounted and not in druid flight form (faster than full visibility check)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1014</span>
                    <span class="line-content">			if self.frame:IsShown() then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1015</span>
                    <span class="line-content">				self.frame:Hide()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1016</span>
                    <span class="line-content">				if self.accelFrame then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1017</span>
                    <span class="line-content">					self.accelFrame:Hide()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1018</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1019</span>
                    <span class="line-content">				if self.surgeForwardFrame then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1020</span>
                    <span class="line-content">					self.surgeForwardFrame:Hide()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1021</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1022</span>
                    <span class="line-content">				if self.secondWindFrame then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1023</span>
                    <span class="line-content">					self.secondWindFrame:Hide()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1024</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1025</span>
                    <span class="line-content">				if self.whirlingSurgeBar then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1026</span>
                    <span class="line-content">					self.whirlingSurgeBar:Hide()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1027</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1028</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1029</span>
                    <span class="line-content">			return</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1030</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1031</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1032</span>
                    <span class="line-content">		self:ApplyVisibility()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1033</span>
                    <span class="line-content">		if not self.frame:IsShown() then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1034</span>
                    <span class="line-content">			return</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1035</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1036</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1037</span>
                    <span class="line-content">		local now = (GetTimePreciseSec and GetTimePreciseSec()) or GetTime()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1038</span>
                    <span class="line-content">		local block_start</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1039</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1040</span>
                    <span class="line-content">		-- 1. Skyriding State &amp; Speed (Primary detection)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1041</span>
                    <span class="line-content">		block_start = debugprofilestop()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1042</span>
                    <span class="line-content">		local speed, isGliding</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1043</span>
                    <span class="line-content">		local ok_state, err_state = pcall(function()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1044</span>
                    <span class="line-content">			self:_UpdateSkyridingState(now)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1045</span>
                    <span class="line-content">			speed, isGliding = self:_GetSkyridingSpeed(now)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1046</span>
                    <span class="line-content">			if not isGliding then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1047</span>
                    <span class="line-content">				speed = GetUnitSpeedSafe(&quot;player&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1048</span>
                    <span class="line-content">				if SafeCompare(speed, 0, &quot;&lt;=&quot;) then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1049</span>
                    <span class="line-content">					speed = self:_GetFallbackSpeedFromPosition(elapsed)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1050</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1051</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1052</span>
                    <span class="line-content">		end)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1053</span>
                    <span class="line-content">		self.perf.blocks.state = debugprofilestop() - block_start</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1054</span>
                    <span class="line-content">		if not ok_state then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1055</span>
                    <span class="line-content">			DebugLog(&quot;State/Speed update error:&quot;, err_state)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1056</span>
                    <span class="line-content">			speed = 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1057</span>
                    <span class="line-content">			isGliding = false</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1058</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1059</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1060</span>
                    <span class="line-content">		-- 2. Speed Bar Update</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1061</span>
                    <span class="line-content">		block_start = debugprofilestop()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1062</span>
                    <span class="line-content">		pcall(function()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1063</span>
                    <span class="line-content">			-- Check for secret values (Midnight combat)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1064</span>
                    <span class="line-content">			local isSpeedSecret = IsSecret(speed)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1065</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1066</span>
                    <span class="line-content">			if isSpeedSecret then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1067</span>
                    <span class="line-content">				DebugLog(&quot;Speed is secret value&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1068</span>
                    <span class="line-content">				-- DEGRADED MODE (Combat)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1069</span>
                    <span class="line-content">				-- Cannot perform arithmetic or string formatting on secret values.</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1070</span>
                    <span class="line-content">				self.speedText:SetText(&quot;???&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1071</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1072</span>
                    <span class="line-content">				-- StatusBar passthrough works - pass the secret speed directly.</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1073</span>
                    <span class="line-content">				-- We must also pass a secret or static max to SetMinMaxValues.</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1074</span>
                    <span class="line-content">				-- Since we can&#x27;t calculate percentage, we scale the bar to a fixed 1000 range</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1075</span>
                    <span class="line-content">				-- and hope the secret value maps relatively well, or just show full.</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1076</span>
                    <span class="line-content">				self.speedBar:SetMinMaxValues(0, 1000) -- Arbitrary high max for secret passthrough</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1077</span>
                    <span class="line-content">				self.speedBar:SetValue(speed)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1078</span>
                    <span class="line-content">				self.speedBar:SetStatusBarColor(0.5, 0.5, 0.5, 1) -- Grey for &quot;restricted&quot;</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1079</span>
                    <span class="line-content">				self.sustainableMarker:Hide()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1080</span>
                    <span class="line-content">			else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1081</span>
                    <span class="line-content">				-- NORMAL MODE</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1082</span>
                    <span class="line-content">				local baseMax = 950</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1083</span>
                    <span class="line-content">				if self.db.profile.speedBar and self.db.profile.speedBar.maxSpeed then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1084</span>
                    <span class="line-content">					baseMax = self.db.profile.speedBar.maxSpeed</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1085</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1086</span>
                    <span class="line-content">				if baseMax &lt;= 0 then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1087</span>
                    <span class="line-content">					baseMax = 950</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1088</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1089</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1090</span>
                    <span class="line-content">				-- Convert raw speed (yards/sec) to percentage (WA-style: ~790% at stable, ~950% max)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1091</span>
                    <span class="line-content">				local speedVal = 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1092</span>
                    <span class="line-content">				if type(speed) == &quot;number&quot; and not IsSecret(speed) then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1093</span>
                    <span class="line-content">					speedVal = speed</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1094</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1095</span>
                    <span class="line-content">				local speedPct = (speedVal / BASE_SPEED_FOR_PCT) * 100</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1096</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1097</span>
                    <span class="line-content">				-- Display as percentage or raw speed</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1098</span>
                    <span class="line-content">				local showPercent = true</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1099</span>
                    <span class="line-content">				if self.db.profile.speedBar and self.db.profile.speedBar.showPercent == false then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1100</span>
                    <span class="line-content">					showPercent = false</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1101</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1102</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1103</span>
                    <span class="line-content">				if showPercent then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1104</span>
                    <span class="line-content">					self.speedText:SetText(string.format(&quot;%.0f%%&quot;, speedPct))</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1105</span>
                    <span class="line-content">				else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1106</span>
                    <span class="line-content">					self.speedText:SetText(string.format(&quot;%.1f&quot;, speedVal))</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1107</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1108</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1109</span>
                    <span class="line-content">				-- Normalize bar fill against maxSpeed (as percentage)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1110</span>
                    <span class="line-content">				local skyriding = self:IsSkyridingActive()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1111</span>
                    <span class="line-content">				if skyriding then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1112</span>
                    <span class="line-content">					local smax = self._sessionMaxSpeed</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1113</span>
                    <span class="line-content">					if smax == nil then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1114</span>
                    <span class="line-content">						smax = 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1115</span>
                    <span class="line-content">					end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1116</span>
                    <span class="line-content">					self._sessionMaxSpeed = math.max(smax, speedPct)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1117</span>
                    <span class="line-content">				else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1118</span>
                    <span class="line-content">					self._sessionMaxSpeed = nil</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1119</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1120</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1121</span>
                    <span class="line-content">				local effectiveMax = baseMax</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1122</span>
                    <span class="line-content">				if skyriding and self._sessionMaxSpeed and self._sessionMaxSpeed &gt; effectiveMax then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1123</span>
                    <span class="line-content">					effectiveMax = self._sessionMaxSpeed</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1124</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1125</span>
                    <span class="line-content">				if effectiveMax &lt;= 0 then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1126</span>
                    <span class="line-content">					effectiveMax = 1</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1127</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1128</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1129</span>
                    <span class="line-content">				local pct = Clamp(speedPct / effectiveMax, 0, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1130</span>
                    <span class="line-content">				self.speedBar:SetMinMaxValues(0, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1131</span>
                    <span class="line-content">				self.speedBar:SetValue(pct)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1132</span>
                    <span class="line-content">				local r, g, b = ColorForPct(pct)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1133</span>
                    <span class="line-content">				self.speedBar:SetStatusBarColor(r, g, b, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1134</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1135</span>
                    <span class="line-content">				local sustainableSpeed = 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1136</span>
                    <span class="line-content">				if self.db.profile.speedBar then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1137</span>
                    <span class="line-content">					sustainableSpeed = self.db.profile.speedBar.sustainableSpeed or self.db.profile.speedBar.optimalSpeed or 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1138</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1139</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1140</span>
                    <span class="line-content">				if sustainableSpeed and sustainableSpeed &gt; 0 then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1141</span>
                    <span class="line-content">					local op = Clamp(sustainableSpeed / effectiveMax, 0, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1142</span>
                    <span class="line-content">					self.sustainableMarker:Show()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1143</span>
                    <span class="line-content">					self.sustainableMarker:ClearAllPoints()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1144</span>
                    <span class="line-content">					self.sustainableMarker:SetPoint(&quot;TOP&quot;, self.speedBar, &quot;TOPLEFT&quot;, op * self.speedBar:GetWidth(), 0)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1145</span>
                    <span class="line-content">					self.sustainableMarker:SetPoint(&quot;BOTTOM&quot;, self.speedBar, &quot;BOTTOMLEFT&quot;, op * self.speedBar:GetWidth(), 0)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1146</span>
                    <span class="line-content">				else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1147</span>
                    <span class="line-content">					self.sustainableMarker:Hide()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1148</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1149</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1150</span>
                    <span class="line-content">				self._lastSpeedPct_Internal = speedPct -- Used for accel bar</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1151</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1152</span>
                    <span class="line-content">		end)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1153</span>
                    <span class="line-content">		self.perf.blocks.speed = debugprofilestop() - block_start</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1154</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1155</span>
                    <span class="line-content">		-- 3. Acceleration Bar Update</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1156</span>
                    <span class="line-content">		block_start = debugprofilestop()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1157</span>
                    <span class="line-content">		pcall(function()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1158</span>
                    <span class="line-content">			local isSpeedSecret = IsSecret(speed)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1159</span>
                    <span class="line-content">			if isSpeedSecret then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1160</span>
                    <span class="line-content">				if self.accelBar then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1161</span>
                    <span class="line-content">					self.accelBar:Hide()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1162</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1163</span>
                    <span class="line-content">				return</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1164</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1165</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1166</span>
                    <span class="line-content">			local speedPct = self._lastSpeedPct_Internal</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1167</span>
                    <span class="line-content">			if speedPct then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1168</span>
                    <span class="line-content">				-- Calculate delta from last frame</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1169</span>
                    <span class="line-content">				local lastSpeedPct = self._lastSpeedPct</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1170</span>
                    <span class="line-content">				if lastSpeedPct == nil then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1171</span>
                    <span class="line-content">					lastSpeedPct = speedPct</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1172</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1173</span>
                    <span class="line-content">				local deltaSpeed = speedPct - lastSpeedPct</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1174</span>
                    <span class="line-content">				self._lastSpeedPct = speedPct</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1175</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1176</span>
                    <span class="line-content">				-- Smooth the delta a bit to avoid jitter</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1177</span>
                    <span class="line-content">				local sDelta = self._smoothDelta</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1178</span>
                    <span class="line-content">				if sDelta == nil then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1179</span>
                    <span class="line-content">					sDelta = 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1180</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1181</span>
                    <span class="line-content">				self._smoothDelta = sDelta * 0.7 + deltaSpeed * 0.3</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1182</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1183</span>
                    <span class="line-content">				-- Update acceleration bar</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1184</span>
                    <span class="line-content">				if self.accelBar and self.accelFrame then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1185</span>
                    <span class="line-content">					self.accelBar:Show()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1186</span>
                    <span class="line-content">					local barWidth = self.accelFrame:GetWidth()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1187</span>
                    <span class="line-content">					local barHeight = self.accelFrame:GetHeight()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1188</span>
                    <span class="line-content">					local centerX = barWidth / 2</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1189</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1190</span>
                    <span class="line-content">					-- Scale: clamp raw delta to ¬±1 range</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1191</span>
                    <span class="line-content">					local maxDelta = 30 -- Max delta per update to show full bar extension</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1192</span>
                    <span class="line-content">					local deltaNorm = Clamp(self._smoothDelta / maxDelta, -1, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1193</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1194</span>
                    <span class="line-content">					-- Apply square root curve: more sensitive near zero, compressed at extremes</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1195</span>
                    <span class="line-content">					-- sqrt(|x|) * sign(x) gives us the ramped response</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1196</span>
                    <span class="line-content">					local sign = deltaNorm &gt;= 0 and 1 or -1</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1197</span>
                    <span class="line-content">					local curved = sign * math.sqrt(math.abs(deltaNorm))</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1198</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1199</span>
                    <span class="line-content">					-- Minimum size is a small square (barHeight x barHeight)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1200</span>
                    <span class="line-content">					local minSize = math.max(barHeight, 2)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1201</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1202</span>
                    <span class="line-content">					self.accelBar:ClearAllPoints()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1203</span>
                    <span class="line-content">					self.accelBar:SetHeight(barHeight)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1204</span>
                    <span class="line-content">					-- Bar is always white</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1205</span>
                    <span class="line-content">					self.accelBar:SetColorTexture(1, 1, 1, 0.9)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1206</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1207</span>
                    <span class="line-content">					if math.abs(curved) &lt; 0.05 then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1208</span>
                    <span class="line-content">						-- Stable: show small centered square</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1209</span>
                    <span class="line-content">						self.accelBar:SetWidth(minSize)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1210</span>
                    <span class="line-content">						self.accelBar:SetPoint(&quot;CENTER&quot;, self.accelFrame, &quot;CENTER&quot;, 0, 0)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1211</span>
                    <span class="line-content">					elseif curved &gt;= 0 then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1212</span>
                    <span class="line-content">						-- Accelerating: bar extends right from center</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1213</span>
                    <span class="line-content">						local extentWidth = curved * centerX</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1214</span>
                    <span class="line-content">						if extentWidth &lt; minSize then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1215</span>
                    <span class="line-content">							extentWidth = minSize</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1216</span>
                    <span class="line-content">						end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1217</span>
                    <span class="line-content">						self.accelBar:SetWidth(extentWidth)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1218</span>
                    <span class="line-content">						self.accelBar:SetPoint(&quot;LEFT&quot;, self.accelFrame, &quot;LEFT&quot;, centerX, 0)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1219</span>
                    <span class="line-content">					else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1220</span>
                    <span class="line-content">						-- Decelerating: bar extends left from center</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1221</span>
                    <span class="line-content">						local extentWidth = -curved * centerX</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1222</span>
                    <span class="line-content">						if extentWidth &lt; minSize then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1223</span>
                    <span class="line-content">							extentWidth = minSize</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1224</span>
                    <span class="line-content">						end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1225</span>
                    <span class="line-content">						self.accelBar:SetWidth(extentWidth)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1226</span>
                    <span class="line-content">						self.accelBar:SetPoint(&quot;RIGHT&quot;, self.accelFrame, &quot;LEFT&quot;, centerX, 0)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1227</span>
                    <span class="line-content">					end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1228</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1229</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1230</span>
                    <span class="line-content">		end)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1231</span>
                    <span class="line-content">		self.perf.blocks.accel = debugprofilestop() - block_start</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1232</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1233</span>
                    <span class="line-content">		-- 4. Shared Ability State (Prep for charges/cooldowns)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1234</span>
                    <span class="line-content">		block_start = debugprofilestop()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1235</span>
                    <span class="line-content">		local surgeInfo, dt, surgeAtMax</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1236</span>
                    <span class="line-content">		local ok_prep, err_prep = pcall(function()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1237</span>
                    <span class="line-content">			DebugLog(&quot;--- Ability Update Start ---&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1238</span>
                    <span class="line-content">			local now_val = GetTime()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1239</span>
                    <span class="line-content">			dt = now_val - (self._lastAbilityUpdate or now_val)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1240</span>
                    <span class="line-content">			self._lastAbilityUpdate = now_val</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1241</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1242</span>
                    <span class="line-content">			DebugLog(&quot;Calling GetSpellCooldownSafe...&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1243</span>
                    <span class="line-content">			surgeInfo = GetSpellCooldownSafe(SURGE_FORWARD_SPELL_ID, true)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1244</span>
                    <span class="line-content">			DebugLog(&quot;surgeInfo obtained&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1245</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1246</span>
                    <span class="line-content">			local surgeChargesRaw = surgeInfo.currentCharges</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1247</span>
                    <span class="line-content">			local surgeMaxRaw = surgeInfo.maxCharges</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1248</span>
                    <span class="line-content">			DebugLog(&quot;Raw charges:&quot;, SafeToString(surgeChargesRaw), &quot;/&quot;, SafeToString(surgeMaxRaw))</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1249</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1250</span>
                    <span class="line-content">			local isSurgeSecret = IsSecret(surgeChargesRaw) or IsSecret(surgeMaxRaw)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1251</span>
                    <span class="line-content">			DebugLog(&quot;isSurgeSecret:&quot;, isSurgeSecret)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1252</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1253</span>
                    <span class="line-content">			if isSurgeSecret then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1254</span>
                    <span class="line-content">				DebugLog(&quot;Surge is secret, using IsSpellUsable&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1255</span>
                    <span class="line-content">				surgeAtMax = C_Spell.IsSpellUsable(SURGE_FORWARD_SPELL_ID) or false</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1256</span>
                    <span class="line-content">			else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1257</span>
                    <span class="line-content">				local m = surgeMaxRaw or 6</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1258</span>
                    <span class="line-content">				DebugLog(&quot;Comparing charges...&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1259</span>
                    <span class="line-content">				surgeAtMax = ((surgeChargesRaw or 0) &gt;= m)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1260</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1261</span>
                    <span class="line-content">			DebugLog(&quot;surgeAtMax:&quot;, surgeAtMax)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1262</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1263</span>
                    <span class="line-content">			-- Show/Hide ability frames based on profile</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1264</span>
                    <span class="line-content">			if self.surgeForwardFrame then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1265</span>
                    <span class="line-content">				if self.db.profile.abilityBars and self.db.profile.abilityBars.showSurgeForward ~= false then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1266</span>
                    <span class="line-content">					self.surgeForwardFrame:Show()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1267</span>
                    <span class="line-content">				else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1268</span>
                    <span class="line-content">					self.surgeForwardFrame:Hide()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1269</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1270</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1271</span>
                    <span class="line-content">			if self.secondWindFrame then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1272</span>
                    <span class="line-content">				if self.db.profile.abilityBars and self.db.profile.abilityBars.showSecondWind then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1273</span>
                    <span class="line-content">					self.secondWindFrame:Show()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1274</span>
                    <span class="line-content">				else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1275</span>
                    <span class="line-content">					self.secondWindFrame:Hide()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1276</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1277</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1278</span>
                    <span class="line-content">			if self.whirlingSurgeBar then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1279</span>
                    <span class="line-content">				if self.db.profile.abilityBars and self.db.profile.abilityBars.showWhirlingSurge then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1280</span>
                    <span class="line-content">					self.whirlingSurgeBar:Show()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1281</span>
                    <span class="line-content">				else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1282</span>
                    <span class="line-content">					self.whirlingSurgeBar:Hide()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1283</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1284</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1285</span>
                    <span class="line-content">		end)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1286</span>
                    <span class="line-content">		self.perf.blocks.prep = debugprofilestop() - block_start</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1287</span>
                    <span class="line-content">		if not ok_prep then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1288</span>
                    <span class="line-content">			DebugLog(&quot;Block 4 (Prep) error:&quot;, err_prep)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1289</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1290</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1291</span>
                    <span class="line-content">		-- 5. Surge Forward Update</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1292</span>
                    <span class="line-content">		block_start = debugprofilestop()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1293</span>
                    <span class="line-content">		local ok_sf, err_sf = pcall(function()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1294</span>
                    <span class="line-content">			DebugLog(&quot;Entering Block 5 (Surge)...&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1295</span>
                    <span class="line-content">			local surgeCondition = self.surgeForwardFrame</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1296</span>
                    <span class="line-content">				and self.surgeForwardBars</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1297</span>
                    <span class="line-content">				and self.db.profile.abilityBars</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1298</span>
                    <span class="line-content">				and self.db.profile.abilityBars.showSurgeForward ~= false</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1299</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1300</span>
                    <span class="line-content">			DebugLog(&quot;Surge condition:&quot;, surgeCondition, &quot;Has surgeInfo:&quot;, surgeInfo ~= nil)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1301</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1302</span>
                    <span class="line-content">			if surgeCondition and surgeInfo then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1303</span>
                    <span class="line-content">				local ANIM_SPEED = 3.0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1304</span>
                    <span class="line-content">				local now_val = GetTime()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1305</span>
                    <span class="line-content">				local surgeChargesRaw = surgeInfo.currentCharges</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1306</span>
                    <span class="line-content">				local surgeMaxRaw = surgeInfo.maxCharges</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1307</span>
                    <span class="line-content">				local isSurgeSecret = IsSecret(surgeChargesRaw) or IsSecret(surgeMaxRaw)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1308</span>
                    <span class="line-content">				local surgeChargesCount = isSurgeSecret and 0 or (surgeChargesRaw or 0)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1309</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1310</span>
                    <span class="line-content">				local cStart = surgeInfo.chargeStart</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1311</span>
                    <span class="line-content">				local cDur = surgeInfo.chargeDuration</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1312</span>
                    <span class="line-content">				local isAnimSecret = IsSecret(cStart) or IsSecret(cDur)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1313</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1314</span>
                    <span class="line-content">				if isSurgeSecret then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1315</span>
                    <span class="line-content">					local usable = C_Spell.IsSpellUsable(SURGE_FORWARD_SPELL_ID) or false</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1316</span>
                    <span class="line-content">					DebugLog(&quot;Surge is secret, usable proxy:&quot;, usable)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1317</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1318</span>
                    <span class="line-content">					-- TEST COLOR: RED if secret to distinguish from non-secret</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1319</span>
                    <span class="line-content">					local r, g, b = 1, 0, 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1320</span>
                    <span class="line-content">					if not self.db.profile.debugMode then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1321</span>
                    <span class="line-content">						r, g, b = COLOR_SURGE_FORWARD[1], COLOR_SURGE_FORWARD[2], COLOR_SURGE_FORWARD[3]</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1322</span>
                    <span class="line-content">					end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1323</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1324</span>
                    <span class="line-content">					for i = 1, 6 do</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1325</span>
                    <span class="line-content">						local bar = self.surgeForwardBars[i]</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1326</span>
                    <span class="line-content">						if bar then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1327</span>
                    <span class="line-content">							-- Midnight Safety: Re-assert bar configuration</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1328</span>
                    <span class="line-content">							bar:SetMinMaxValues(0, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1329</span>
                    <span class="line-content">							bar:SetStatusBarTexture(&quot;Interface/Buttons/WHITE8X8&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1330</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1331</span>
                    <span class="line-content">							-- DIRECT HUD TEST: If debug is on, make the first bar BRIGHT GREEN and ALWAYS FULL</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1332</span>
                    <span class="line-content">							if i == 1 and self.db.profile.debugMode then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1333</span>
                    <span class="line-content">								bar:SetValue(1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1334</span>
                    <span class="line-content">								bar:SetStatusBarColor(0, 1, 0, 1) -- Bright Green</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1335</span>
                    <span class="line-content">							else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1336</span>
                    <span class="line-content">								bar:SetValue(usable and 1 or 0)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1337</span>
                    <span class="line-content">								bar:SetStatusBarColor(r, g, b, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1338</span>
                    <span class="line-content">							end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1339</span>
                    <span class="line-content">							bar:SetAlpha(1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1340</span>
                    <span class="line-content">						end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1341</span>
                    <span class="line-content">					end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1342</span>
                    <span class="line-content">				else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1343</span>
                    <span class="line-content">					local chargeStart = (cStart ~= nil and not IsSecret(cStart)) and cStart or 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1344</span>
                    <span class="line-content">					local chargeDuration = (cDur ~= nil and not IsSecret(cDur)) and cDur or 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1345</span>
                    <span class="line-content">					local barAlpha = 1</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1346</span>
                    <span class="line-content">					local bgAlpha = 0.85</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1347</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1348</span>
                    <span class="line-content">					for i = 1, 6 do</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1349</span>
                    <span class="line-content">						local bar = self.surgeForwardBars[i]</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1350</span>
                    <span class="line-content">						local bg = self.surgeForwardBarBgs and self.surgeForwardBarBgs[i]</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1351</span>
                    <span class="line-content">						if bar then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1352</span>
                    <span class="line-content">							if bg then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1353</span>
                    <span class="line-content">								bg:SetColorTexture(0.08, 0.12, 0.18, bgAlpha)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1354</span>
                    <span class="line-content">							end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1355</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1356</span>
                    <span class="line-content">							local targetPct = 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1357</span>
                    <span class="line-content">							if SafeCompare(i, surgeChargesCount, &quot;&lt;=&quot;) then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1358</span>
                    <span class="line-content">								targetPct = 1</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1359</span>
                    <span class="line-content">							elseif SafeCompare(i, surgeChargesCount + 1, &quot;==&quot;) and chargeDuration &gt; 0 and not isAnimSecret then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1360</span>
                    <span class="line-content">								local cdElapsed = now_val - chargeStart</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1361</span>
                    <span class="line-content">								targetPct = Clamp(cdElapsed / chargeDuration, 0, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1362</span>
                    <span class="line-content">							else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1363</span>
                    <span class="line-content">								targetPct = 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1364</span>
                    <span class="line-content">							end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1365</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1366</span>
                    <span class="line-content">							local lastTarget = (self._surgeForwardLastTarget and self._surgeForwardLastTarget[i]) or 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1367</span>
                    <span class="line-content">							self._surgeForwardLastTarget = self._surgeForwardLastTarget or {}</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1368</span>
                    <span class="line-content">							self._surgeForwardLastTarget[i] = targetPct</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1369</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1370</span>
                    <span class="line-content">							if SafeCompare(targetPct, 1, &quot;&gt;=&quot;) and SafeCompare(lastTarget, 1, &quot;&lt;&quot;) then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1371</span>
                    <span class="line-content">								self._surgeForwardAnimating[i] = true</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1372</span>
                    <span class="line-content">							end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1373</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1374</span>
                    <span class="line-content">							if self._surgeForwardAnimating[i] then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1375</span>
                    <span class="line-content">								local val = (self._surgeForwardAnimValue[i] or 0) + dt * ANIM_SPEED</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1376</span>
                    <span class="line-content">								if val &gt;= 1 then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1377</span>
                    <span class="line-content">									val = 1</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1378</span>
                    <span class="line-content">									self._surgeForwardAnimating[i] = false</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1379</span>
                    <span class="line-content">								end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1380</span>
                    <span class="line-content">								self._surgeForwardAnimValue[i] = val</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1381</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1382</span>
                    <span class="line-content">								-- Midnight Safety: Re-assert configuration every frame</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1383</span>
                    <span class="line-content">								bar:SetStatusBarTexture(&quot;Interface/Buttons/WHITE8X8&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1384</span>
                    <span class="line-content">								bar:SetMinMaxValues(0, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1385</span>
                    <span class="line-content">								bar:SetValue(val)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1386</span>
                    <span class="line-content">								local r_val, g_val, b_val = ColorForPctSurgeForward(val)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1387</span>
                    <span class="line-content">								bar:SetStatusBarColor(r_val, g_val, b_val, barAlpha)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1388</span>
                    <span class="line-content">								bar:SetAlpha(1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1389</span>
                    <span class="line-content">							else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1390</span>
                    <span class="line-content">								self._surgeForwardAnimValue[i] = targetPct</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1391</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1392</span>
                    <span class="line-content">								-- Midnight Safety: Re-assert configuration every frame</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1393</span>
                    <span class="line-content">								bar:SetStatusBarTexture(&quot;Interface/Buttons/WHITE8X8&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1394</span>
                    <span class="line-content">								bar:SetMinMaxValues(0, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1395</span>
                    <span class="line-content">								bar:SetValue(targetPct)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1396</span>
                    <span class="line-content">								local r_val, g_val, b_val = ColorForPctSurgeForward(targetPct)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1397</span>
                    <span class="line-content">								bar:SetStatusBarColor(r_val, g_val, b_val, barAlpha)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1398</span>
                    <span class="line-content">								bar:SetAlpha(1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1399</span>
                    <span class="line-content">							end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1400</span>
                    <span class="line-content">						end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1401</span>
                    <span class="line-content">					end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1402</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1403</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1404</span>
                    <span class="line-content">		end)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1405</span>
                    <span class="line-content">		self.perf.blocks.surge = debugprofilestop() - block_start</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1406</span>
                    <span class="line-content">		if not ok_sf then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1407</span>
                    <span class="line-content">			DebugLog(&quot;Block 5 (Surge) error:&quot;, err_sf)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1408</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1409</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1410</span>
                    <span class="line-content">		-- 6. Whirling Surge Update</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1411</span>
                    <span class="line-content">		block_start = debugprofilestop()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1412</span>
                    <span class="line-content">		local ok_ws, err_ws = pcall(function()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1413</span>
                    <span class="line-content">			DebugLog(&quot;Entering Block 6 (Whirling)...&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1414</span>
                    <span class="line-content">			if self.whirlingSurgeBar and self.db.profile.abilityBars and self.db.profile.abilityBars.showWhirlingSurge then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1415</span>
                    <span class="line-content">				local info_ws = GetSpellCooldownSafe(WHIRLING_SURGE_SPELL_ID)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1416</span>
                    <span class="line-content">				local ws_dur = info_ws.duration</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1417</span>
                    <span class="line-content">				local ws_start = info_ws.startTime</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1418</span>
                    <span class="line-content">				local isWSSecret = IsSecret(ws_dur) or IsSecret(ws_start)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1419</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1420</span>
                    <span class="line-content">				if isWSSecret then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1421</span>
                    <span class="line-content">					local usable = C_Spell.IsSpellUsable(WHIRLING_SURGE_SPELL_ID)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1422</span>
                    <span class="line-content">					DebugLog(&quot;Whirling is secret, usable proxy:&quot;, usable)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1423</span>
                    <span class="line-content">					-- Midnight Safety: Re-assert bar configuration</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1424</span>
                    <span class="line-content">					self.whirlingSurgeBar:SetMinMaxValues(0, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1425</span>
                    <span class="line-content">					self.whirlingSurgeBar:SetStatusBarTexture(&quot;Interface/Buttons/WHITE8X8&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1426</span>
                    <span class="line-content">					self.whirlingSurgeBar:SetValue(usable and 1 or 0)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1427</span>
                    <span class="line-content">					self.whirlingSurgeBar:SetStatusBarColor(COLOR_WHIRLING_SURGE[1], COLOR_WHIRLING_SURGE[2], COLOR_WHIRLING_SURGE[3], 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1428</span>
                    <span class="line-content">					self.whirlingSurgeBar:SetAlpha(1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1429</span>
                    <span class="line-content">				else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1430</span>
                    <span class="line-content">					local onCooldown = ws_dur and ws_dur &gt; 1.5</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1431</span>
                    <span class="line-content">					local now_val = GetTime()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1432</span>
                    <span class="line-content">					local ANIM_SPEED = 3.0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1433</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1434</span>
                    <span class="line-content">					if onCooldown then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1435</span>
                    <span class="line-content">						local cdElapsed = now_val - (ws_start or now_val)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1436</span>
                    <span class="line-content">						local pct_ws = Clamp(cdElapsed / ws_dur, 0, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1437</span>
                    <span class="line-content">						if self._whirlingSurgeWasReady then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1438</span>
                    <span class="line-content">							self._whirlingSurgeAnimating = false</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1439</span>
                    <span class="line-content">							self._whirlingSurgeAnimValue = 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1440</span>
                    <span class="line-content">						end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1441</span>
                    <span class="line-content">						self._whirlingSurgeWasReady = false</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1442</span>
                    <span class="line-content">						self.whirlingSurgeBar:SetValue(pct_ws)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1443</span>
                    <span class="line-content">						local r_ws, g_ws, b_ws = ColorForPctBlue(pct_ws)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1444</span>
                    <span class="line-content">						self.whirlingSurgeBar:SetStatusBarColor(r_ws, g_ws, b_ws, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1445</span>
                    <span class="line-content">					else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1446</span>
                    <span class="line-content">						if not self._whirlingSurgeWasReady and (self._whirlingSurgeAnimValue or 0) &lt; 1 then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1447</span>
                    <span class="line-content">							self._whirlingSurgeAnimating = true</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1448</span>
                    <span class="line-content">						end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1449</span>
                    <span class="line-content">						self._whirlingSurgeWasReady = true</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1450</span>
                    <span class="line-content">						if self._whirlingSurgeAnimating then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1451</span>
                    <span class="line-content">							local val = (self._whirlingSurgeAnimValue or 0) + dt * ANIM_SPEED</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1452</span>
                    <span class="line-content">							if val &gt;= 1 then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1453</span>
                    <span class="line-content">								val = 1</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1454</span>
                    <span class="line-content">								self._whirlingSurgeAnimating = false</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1455</span>
                    <span class="line-content">							end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1456</span>
                    <span class="line-content">							self._whirlingSurgeAnimValue = val</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1457</span>
                    <span class="line-content">							-- Midnight Safety</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1458</span>
                    <span class="line-content">							self.whirlingSurgeBar:SetStatusBarTexture(&quot;Interface/Buttons/WHITE8X8&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1459</span>
                    <span class="line-content">							self.whirlingSurgeBar:SetMinMaxValues(0, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1460</span>
                    <span class="line-content">							self.whirlingSurgeBar:SetValue(val)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1461</span>
                    <span class="line-content">							local r_ws, g_ws, b_ws = ColorForPctBlue(val)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1462</span>
                    <span class="line-content">							self.whirlingSurgeBar:SetStatusBarColor(r_ws, g_ws, b_ws, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1463</span>
                    <span class="line-content">							self.whirlingSurgeBar:SetAlpha(1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1464</span>
                    <span class="line-content">						else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1465</span>
                    <span class="line-content">							-- Midnight Safety</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1466</span>
                    <span class="line-content">							self.whirlingSurgeBar:SetStatusBarTexture(&quot;Interface/Buttons/WHITE8X8&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1467</span>
                    <span class="line-content">							self.whirlingSurgeBar:SetMinMaxValues(0, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1468</span>
                    <span class="line-content">							self.whirlingSurgeBar:SetValue(1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1469</span>
                    <span class="line-content">							local r_ws, g_ws, b_ws = ColorForPctBlue(1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1470</span>
                    <span class="line-content">							self.whirlingSurgeBar:SetStatusBarColor(r_ws, g_ws, b_ws, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1471</span>
                    <span class="line-content">							self.whirlingSurgeBar:SetAlpha(1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1472</span>
                    <span class="line-content">						end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1473</span>
                    <span class="line-content">					end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1474</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1475</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1476</span>
                    <span class="line-content">		end)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1477</span>
                    <span class="line-content">		self.perf.blocks.whirling = debugprofilestop() - block_start</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1478</span>
                    <span class="line-content">		if not ok_ws then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1479</span>
                    <span class="line-content">			DebugLog(&quot;Block 6 (Whirling) error:&quot;, err_ws)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1480</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1481</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1482</span>
                    <span class="line-content">		-- 7. Second Wind Update</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1483</span>
                    <span class="line-content">		block_start = debugprofilestop()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1484</span>
                    <span class="line-content">		local ok_wind, err_wind = pcall(function()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1485</span>
                    <span class="line-content">			DebugLog(&quot;Entering Block 7 (Wind)...&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1486</span>
                    <span class="line-content">			if self.secondWindFrame and self.secondWindBars and self.db.profile.abilityBars and self.db.profile.abilityBars.showSecondWind then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1487</span>
                    <span class="line-content">				local info_sw = GetSpellCooldownSafe(SECOND_WIND_SPELL_ID, true)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1488</span>
                    <span class="line-content">				local swChargesRaw = info_sw.currentCharges</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1489</span>
                    <span class="line-content">				local swStart = info_sw.chargeStart</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1490</span>
                    <span class="line-content">				local swDur = info_sw.chargeDuration</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1491</span>
                    <span class="line-content">				local isSWSecret = IsSecret(swChargesRaw) or IsSecret(swStart) or IsSecret(swDur)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1492</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1493</span>
                    <span class="line-content">				if isSWSecret then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1494</span>
                    <span class="line-content">					local usable = C_Spell.IsSpellUsable(SECOND_WIND_SPELL_ID)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1495</span>
                    <span class="line-content">					DebugLog(&quot;Wind is secret, usable proxy:&quot;, usable)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1496</span>
                    <span class="line-content">					local barAlpha = surgeAtMax and 0.2 or 1</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1497</span>
                    <span class="line-content">					for i = 1, 3 do</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1498</span>
                    <span class="line-content">						local bar = self.secondWindBars[i]</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1499</span>
                    <span class="line-content">						if bar then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1500</span>
                    <span class="line-content">							-- Midnight Safety: Re-assert bar configuration</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1501</span>
                    <span class="line-content">							bar:SetMinMaxValues(0, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1502</span>
                    <span class="line-content">							bar:SetStatusBarTexture(&quot;Interface/Buttons/WHITE8X8&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1503</span>
                    <span class="line-content">							bar:SetValue(usable and 1 or 0)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1504</span>
                    <span class="line-content">							bar:SetStatusBarColor(COLOR_SECOND_WIND[1], COLOR_SECOND_WIND[2], COLOR_SECOND_WIND[3], barAlpha)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1505</span>
                    <span class="line-content">							bar:SetAlpha(1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1506</span>
                    <span class="line-content">						end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1507</span>
                    <span class="line-content">					end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1508</span>
                    <span class="line-content">				else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1509</span>
                    <span class="line-content">					local currentCharges = swChargesRaw or 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1510</span>
                    <span class="line-content">					local chargeStart = swStart or 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1511</span>
                    <span class="line-content">					local chargeDuration = swDur or 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1512</span>
                    <span class="line-content">					local barAlpha = surgeAtMax and 0.2 or 1</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1513</span>
                    <span class="line-content">					local bgAlpha = surgeAtMax and 0.17 or 0.85</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1514</span>
                    <span class="line-content">					local now_val = GetTime()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1515</span>
                    <span class="line-content">					local ANIM_SPEED = 3.0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1516</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1517</span>
                    <span class="line-content">					for i = 1, 3 do</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1518</span>
                    <span class="line-content">						local bar = self.secondWindBars[i]</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1519</span>
                    <span class="line-content">						local bg = self.secondWindBarBgs and self.secondWindBarBgs[i]</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1520</span>
                    <span class="line-content">						if bar then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1521</span>
                    <span class="line-content">							if bg then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1522</span>
                    <span class="line-content">								bg:SetColorTexture(0.08, 0.12, 0.18, bgAlpha)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1523</span>
                    <span class="line-content">							end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1524</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1525</span>
                    <span class="line-content">							local targetPct = 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1526</span>
                    <span class="line-content">							if SafeCompare(i, currentCharges, &quot;&lt;=&quot;) then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1527</span>
                    <span class="line-content">								targetPct = 1</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1528</span>
                    <span class="line-content">							elseif SafeCompare(i, currentCharges + 1, &quot;==&quot;) and chargeDuration &gt; 0 then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1529</span>
                    <span class="line-content">								local cdElapsed = now_val - chargeStart</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1530</span>
                    <span class="line-content">								targetPct = Clamp(cdElapsed / chargeDuration, 0, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1531</span>
                    <span class="line-content">							else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1532</span>
                    <span class="line-content">								targetPct = 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1533</span>
                    <span class="line-content">							end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1534</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1535</span>
                    <span class="line-content">							local lastTarget = (self._secondWindLastTarget and self._secondWindLastTarget[i]) or 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1536</span>
                    <span class="line-content">							self._secondWindLastTarget = self._secondWindLastTarget or {}</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1537</span>
                    <span class="line-content">							self._secondWindLastTarget[i] = targetPct</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1538</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1539</span>
                    <span class="line-content">							if SafeCompare(targetPct, 1, &quot;&gt;=&quot;) and SafeCompare(lastTarget, 1, &quot;&lt;&quot;) then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1540</span>
                    <span class="line-content">								self._secondWindAnimating[i] = true</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1541</span>
                    <span class="line-content">							end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1542</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1543</span>
                    <span class="line-content">							if self._secondWindAnimating[i] then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1544</span>
                    <span class="line-content">								local val = (self._secondWindAnimValue[i] or 0) + dt * ANIM_SPEED</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1545</span>
                    <span class="line-content">								if val &gt;= 1 then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1546</span>
                    <span class="line-content">									val = 1</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1547</span>
                    <span class="line-content">									self._secondWindAnimating[i] = false</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1548</span>
                    <span class="line-content">								end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1549</span>
                    <span class="line-content">								self._secondWindAnimValue[i] = val</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1550</span>
                    <span class="line-content">								-- Midnight Safety</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1551</span>
                    <span class="line-content">								bar:SetStatusBarTexture(&quot;Interface/Buttons/WHITE8X8&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1552</span>
                    <span class="line-content">								bar:SetMinMaxValues(0, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1553</span>
                    <span class="line-content">								bar:SetValue(val)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1554</span>
                    <span class="line-content">								local r_sw, g_sw, b_sw = ColorForPctPurple(val)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1555</span>
                    <span class="line-content">								bar:SetStatusBarColor(r_sw, g_sw, b_sw, barAlpha)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1556</span>
                    <span class="line-content">								bar:SetAlpha(1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1557</span>
                    <span class="line-content">							else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1558</span>
                    <span class="line-content">								self._secondWindAnimValue[i] = targetPct</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1559</span>
                    <span class="line-content">								-- Midnight Safety</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1560</span>
                    <span class="line-content">								bar:SetStatusBarTexture(&quot;Interface/Buttons/WHITE8X8&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1561</span>
                    <span class="line-content">								bar:SetMinMaxValues(0, 1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1562</span>
                    <span class="line-content">								bar:SetValue(targetPct)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1563</span>
                    <span class="line-content">								local r_sw, g_sw, b_sw = ColorForPctPurple(targetPct)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1564</span>
                    <span class="line-content">								bar:SetStatusBarColor(r_sw, g_sw, b_sw, barAlpha)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1565</span>
                    <span class="line-content">								bar:SetAlpha(1)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1566</span>
                    <span class="line-content">							end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1567</span>
                    <span class="line-content">						end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1568</span>
                    <span class="line-content">					end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1569</span>
                    <span class="line-content">				end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1570</span>
                    <span class="line-content">			end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1571</span>
                    <span class="line-content">		end)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1572</span>
                    <span class="line-content">		self.perf.blocks.wind = debugprofilestop() - block_start</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1573</span>
                    <span class="line-content">		if not ok_wind then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1574</span>
                    <span class="line-content">			DebugLog(&quot;Block 7 (Wind) error:&quot;, err_wind)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1575</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1576</span>
                    <span class="line-content">	end)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1577</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1578</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1579</span>
                    <span class="line-content">function FlightsimUI:SetScale(scale)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1580</span>
                    <span class="line-content">	scale = Clamp(scale or 1, 0.5, 2.0)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1581</span>
                    <span class="line-content">	self.db.profile.scale = scale</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1582</span>
                    <span class="line-content">	-- Apply scale to all frames</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1583</span>
                    <span class="line-content">	if self.frame then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1584</span>
                    <span class="line-content">		self.frame:SetScale(scale)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1585</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1586</span>
                    <span class="line-content">	if self.accelFrame then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1587</span>
                    <span class="line-content">		self.accelFrame:SetScale(scale)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1588</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1589</span>
                    <span class="line-content">	if self.surgeForwardFrame then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1590</span>
                    <span class="line-content">		self.surgeForwardFrame:SetScale(scale)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1591</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1592</span>
                    <span class="line-content">	if self.secondWindFrame then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1593</span>
                    <span class="line-content">		self.secondWindFrame:SetScale(scale)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1594</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1595</span>
                    <span class="line-content">	if self.whirlingSurgeBar then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1596</span>
                    <span class="line-content">		self.whirlingSurgeBar:SetScale(scale)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1597</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1598</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1599</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1600</span>
                    <span class="line-content">function FlightsimUI:SetWidth(width)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1601</span>
                    <span class="line-content">	width = tonumber(width)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1602</span>
                    <span class="line-content">	if not width then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1603</span>
                    <span class="line-content">		return</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1604</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1605</span>
                    <span class="line-content">	width = Clamp(width, 50, 800)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1606</span>
                    <span class="line-content">	self.db.profile.ui.width = width</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1607</span>
                    <span class="line-content">	self:RebuildLayout()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1608</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1609</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1610</span>
                    <span class="line-content">function FlightsimUI:SetBarHeight(height)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1611</span>
                    <span class="line-content">	height = tonumber(height)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1612</span>
                    <span class="line-content">	if not height then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1613</span>
                    <span class="line-content">		return</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1614</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1615</span>
                    <span class="line-content">	height = Clamp(height, 10, 100)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1616</span>
                    <span class="line-content">	self.db.profile.ui.speedBarHeight = height</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1617</span>
                    <span class="line-content">	self:RebuildLayout()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1618</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1619</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1620</span>
                    <span class="line-content">function FlightsimUI:SetSpeedBarMax(maxSpeed)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1621</span>
                    <span class="line-content">	maxSpeed = tonumber(maxSpeed)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1622</span>
                    <span class="line-content">	if not maxSpeed then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1623</span>
                    <span class="line-content">		return</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1624</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1625</span>
                    <span class="line-content">	maxSpeed = Clamp(maxSpeed, 100, 1500)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1626</span>
                    <span class="line-content">	self.db.profile.speedBar.maxSpeed = maxSpeed</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1627</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1628</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1629</span>
                    <span class="line-content">function FlightsimUI:SetFontSize(fontSize)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1630</span>
                    <span class="line-content">	fontSize = tonumber(fontSize)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1631</span>
                    <span class="line-content">	if not fontSize then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1632</span>
                    <span class="line-content">		return</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1633</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1634</span>
                    <span class="line-content">	fontSize = Clamp(fontSize, 8, 48)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1635</span>
                    <span class="line-content">	self.db.profile.speedBar.fontSize = fontSize</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1636</span>
                    <span class="line-content">	if self.speedText then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1637</span>
                    <span class="line-content">		self.speedText:SetFont(&quot;Fonts\\ARIALN.TTF&quot;, fontSize, &quot;OUTLINE&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1638</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1639</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1640</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1641</span>
                    <span class="line-content">function FlightsimUI:SetSustainableSpeed(sustainableSpeed)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1642</span>
                    <span class="line-content">	sustainableSpeed = tonumber(sustainableSpeed)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1643</span>
                    <span class="line-content">	if not sustainableSpeed then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1644</span>
                    <span class="line-content">		return</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1645</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1646</span>
                    <span class="line-content">	local maxSpeed = (self.db.profile.speedBar and self.db.profile.speedBar.maxSpeed) or 1100</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1647</span>
                    <span class="line-content">	sustainableSpeed = Clamp(sustainableSpeed, 0, maxSpeed)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1648</span>
                    <span class="line-content">	self.db.profile.speedBar.sustainableSpeed = sustainableSpeed</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1649</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1650</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1651</span>
                    <span class="line-content">function FlightsimUI:DebugDump()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1652</span>
                    <span class="line-content">	local L = Flightsim.L</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1653</span>
                    <span class="line-content">	local function PrintKV(k, v)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1654</span>
                    <span class="line-content">		print(string.format(L[&quot;DEBUG_KV&quot;], tostring(k), tostring(v)))</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1655</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1656</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1657</span>
                    <span class="line-content">	-- Use C_AddOns.IsAddOnLoaded (modern) or fall back to IsAddOnLoaded (legacy)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1658</span>
                    <span class="line-content">	local function IsAddonLoaded(name)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1659</span>
                    <span class="line-content">		if C_AddOns and C_AddOns.IsAddOnLoaded then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1660</span>
                    <span class="line-content">			return C_AddOns.IsAddOnLoaded(name)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1661</span>
                    <span class="line-content">		elseif IsAddOnLoaded then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1662</span>
                    <span class="line-content">			return IsAddOnLoaded(name)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1663</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1664</span>
                    <span class="line-content">		return false</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1665</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1666</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1667</span>
                    <span class="line-content">	print(L[&quot;DEBUG_HEADER&quot;])</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1668</span>
                    <span class="line-content">	-- Use C_AddOns.GetAddOnMetadata (modern) or fall back to GetAddOnMetadata (legacy)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1669</span>
                    <span class="line-content">	local version = &quot;?&quot;</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1670</span>
                    <span class="line-content">	if C_AddOns and C_AddOns.GetAddOnMetadata then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1671</span>
                    <span class="line-content">		version = C_AddOns.GetAddOnMetadata(&quot;Flightsim&quot;, &quot;Version&quot;) or &quot;?&quot;</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1672</span>
                    <span class="line-content">	elseif GetAddOnMetadata then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1673</span>
                    <span class="line-content">		version = GetAddOnMetadata(&quot;Flightsim&quot;, &quot;Version&quot;) or &quot;?&quot;</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1674</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1675</span>
                    <span class="line-content">	PrintKV(&quot;Version&quot;, version)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1676</span>
                    <span class="line-content">	-- BugGrabber folder is named &quot;!BugGrabber&quot; (with ! prefix for load order)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1677</span>
                    <span class="line-content">	PrintKV(&quot;BugGrabber loaded&quot;, (IsAddonLoaded(&quot;!BugGrabber&quot;) or IsAddonLoaded(&quot;BugGrabber&quot;)) and &quot;yes&quot; or &quot;no&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1678</span>
                    <span class="line-content">	PrintKV(&quot;BugSack loaded&quot;, IsAddonLoaded(&quot;BugSack&quot;) and &quot;yes&quot; or &quot;no&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1679</span>
                    <span class="line-content">	PrintKV(&quot;Has GetSpellCharges&quot;, type(GetSpellCharges) == &quot;function&quot; and &quot;yes&quot; or &quot;no&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1680</span>
                    <span class="line-content">	PrintKV(&quot;Has C_Spell.GetSpellCharges&quot;, (C_Spell and type(C_Spell.GetSpellCharges) == &quot;function&quot;) and &quot;yes&quot; or &quot;no&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1681</span>
                    <span class="line-content">	PrintKV(</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1682</span>
                    <span class="line-content">		&quot;Has C_PlayerInfo.IsPlayerInSkyriding&quot;,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1683</span>
                    <span class="line-content">		(C_PlayerInfo and type(C_PlayerInfo.IsPlayerInSkyriding) == &quot;function&quot;) and &quot;yes&quot; or &quot;no&quot;</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1684</span>
                    <span class="line-content">	)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1685</span>
                    <span class="line-content">	PrintKV(</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1686</span>
                    <span class="line-content">		&quot;Has C_PlayerInfo.IsPlayerInDragonriding&quot;,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1687</span>
                    <span class="line-content">		(C_PlayerInfo and type(C_PlayerInfo.IsPlayerInDragonriding) == &quot;function&quot;) and &quot;yes&quot; or &quot;no&quot;</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1688</span>
                    <span class="line-content">	)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1689</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1690</span>
                    <span class="line-content">	if not (self.db and self.db.profile) then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1691</span>
                    <span class="line-content">		print(L[&quot;DEBUG_DB_NOT_INIT&quot;])</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1692</span>
                    <span class="line-content">		return</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1693</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1694</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1695</span>
                    <span class="line-content">	local p = self.db.profile</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1696</span>
                    <span class="line-content">	PrintKV(&quot;locked&quot;, p.locked)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1697</span>
                    <span class="line-content">	PrintKV(&quot;x&quot;, p.x)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1698</span>
                    <span class="line-content">	PrintKV(&quot;y&quot;, p.y)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1699</span>
                    <span class="line-content">	PrintKV(&quot;scale&quot;, p.scale)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1700</span>
                    <span class="line-content">	PrintKV(&quot;ui.width&quot;, p.ui and p.ui.width)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1701</span>
                    <span class="line-content">	PrintKV(&quot;speedBar.maxSpeed&quot;, p.speedBar and p.speedBar.maxSpeed)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1702</span>
                    <span class="line-content">	PrintKV(&quot;speedBar.optimalSpeed&quot;, p.speedBar and p.speedBar.optimalSpeed)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1703</span>
                    <span class="line-content">	PrintKV(&quot;hideWhenNotSkyriding&quot;, p.visibility and p.visibility.hideWhenNotSkyriding)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1704</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1705</span>
                    <span class="line-content">	local speed = GetUnitSpeedSafe(&quot;player&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1706</span>
                    <span class="line-content">	PrintKV(&quot;GetUnitSpeed(player)&quot;, string.format(&quot;%.2f&quot;, speed))</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1707</span>
                    <span class="line-content">	PrintKV(&quot;IsMounted&quot;, IsMounted() and &quot;yes&quot; or &quot;no&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1708</span>
                    <span class="line-content">	PrintKV(&quot;IsFlying&quot;, IsFlying() and &quot;yes&quot; or &quot;no&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1709</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1710</span>
                    <span class="line-content">	-- Detailed GetGlidingInfo debug</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1711</span>
                    <span class="line-content">	if C_PlayerInfo and C_PlayerInfo.GetGlidingInfo then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1712</span>
                    <span class="line-content">		local ok, isGliding, canGlide, forwardSpeed = pcall(C_PlayerInfo.GetGlidingInfo)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1713</span>
                    <span class="line-content">		PrintKV(&quot;GetGlidingInfo.ok&quot;, ok and &quot;yes&quot; or &quot;no&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1714</span>
                    <span class="line-content">		PrintKV(&quot;GetGlidingInfo.isGliding&quot;, isGliding and &quot;yes&quot; or &quot;no&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1715</span>
                    <span class="line-content">		PrintKV(&quot;GetGlidingInfo.canGlide&quot;, canGlide and &quot;yes&quot; or &quot;no&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1716</span>
                    <span class="line-content">		PrintKV(&quot;GetGlidingInfo.forwardSpeed&quot;, tostring(forwardSpeed))</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1717</span>
                    <span class="line-content">	else</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1718</span>
                    <span class="line-content">		PrintKV(&quot;GetGlidingInfo&quot;, &quot;API not available&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1719</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1720</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1721</span>
                    <span class="line-content">	PrintKV(&quot;IsSkyridingActive&quot;, self:IsSkyridingActive() and &quot;yes&quot; or &quot;no&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1722</span>
                    <span class="line-content">	PrintKV(&quot;Frame shown&quot;, (self.frame and self.frame:IsShown()) and &quot;yes&quot; or &quot;no&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1723</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1724</span>
                    <span class="line-content">	print(L[&quot;DEBUG_ABILITIES_HEADER&quot;])</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1725</span>
                    <span class="line-content">	for i, token in ipairs((p.abilities and p.abilities.order) or {}) do</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1726</span>
                    <span class="line-content">		local enabled = (p.abilities.enabled == nil) or (p.abilities.enabled[token] ~= false)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1727</span>
                    <span class="line-content">		local spellID, iconID = ResolveSpellInfo(token)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1728</span>
                    <span class="line-content">		local cur, max = nil, nil</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1729</span>
                    <span class="line-content">		if spellID then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1730</span>
                    <span class="line-content">			cur, max = GetSpellChargesSafe(spellID)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1731</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1732</span>
                    <span class="line-content">		print(</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1733</span>
                    <span class="line-content">			string.format(</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1734</span>
                    <span class="line-content">				L[&quot;DEBUG_ABILITY_FORMAT&quot;],</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1735</span>
                    <span class="line-content">				i,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1736</span>
                    <span class="line-content">				tostring(token),</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1737</span>
                    <span class="line-content">				enabled and &quot;yes&quot; or &quot;no&quot;,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1738</span>
                    <span class="line-content">				tostring(spellID),</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1739</span>
                    <span class="line-content">				tostring(iconID),</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1740</span>
                    <span class="line-content">				tostring(cur),</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1741</span>
                    <span class="line-content">				tostring(max)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1742</span>
                    <span class="line-content">			)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1743</span>
                    <span class="line-content">		)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1744</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1745</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1746</span>
                    <span class="line-content">	print(L[&quot;DEBUG_FOOTER&quot;])</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1747</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1748</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1749</span>
                    <span class="line-content">function FlightsimUI:Status()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1750</span>
                    <span class="line-content">	local L = Flightsim.L</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1751</span>
                    <span class="line-content">	if not (self.db and self.db.profile) then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1752</span>
                    <span class="line-content">		print(L[&quot;STATUS_NOT_INIT&quot;])</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1753</span>
                    <span class="line-content">		return</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1754</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1755</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1756</span>
                    <span class="line-content">	local skyriding = self:IsSkyridingActive()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1757</span>
                    <span class="line-content">	local speed = GetUnitSpeedSafe(&quot;player&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1758</span>
                    <span class="line-content">	local maxSpeed = (self.db.profile.speedBar and self.db.profile.speedBar.maxSpeed) or 20</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1759</span>
                    <span class="line-content">	local optimalSpeed = (self.db.profile.speedBar and self.db.profile.speedBar.optimalSpeed) or 0</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1760</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1761</span>
                    <span class="line-content">	local showState = (self.frame and self.frame:IsShown()) and L[&quot;SHOWN&quot;] or L[&quot;HIDDEN&quot;]</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1762</span>
                    <span class="line-content">	local ridingState = skyriding and L[&quot;SKYRIDING&quot;] or L[&quot;NOT_SKYRIDING&quot;]</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1763</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1764</span>
                    <span class="line-content">	local chargeState = L[&quot;CHARGES_DISABLED&quot;]</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1765</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1766</span>
                    <span class="line-content">	local optimalStr = (optimalSpeed and optimalSpeed &gt; 0) and string.format(L[&quot;OPTIMAL_FORMAT&quot;], optimalSpeed)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1767</span>
                    <span class="line-content">		or L[&quot;OPTIMAL_OFF&quot;]</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1768</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1769</span>
                    <span class="line-content">	print(</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1770</span>
                    <span class="line-content">		string.format(</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1771</span>
                    <span class="line-content">			L[&quot;STATUS_FORMAT&quot;],</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1772</span>
                    <span class="line-content">			ridingState,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1773</span>
                    <span class="line-content">			showState,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1774</span>
                    <span class="line-content">			speed,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1775</span>
                    <span class="line-content">			maxSpeed,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1776</span>
                    <span class="line-content">			optimalStr,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1777</span>
                    <span class="line-content">			chargeState</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1778</span>
                    <span class="line-content">		)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1779</span>
                    <span class="line-content">	)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1780</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1781</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1782</span>
                    <span class="line-content">-- ============================================================</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1783</span>
                    <span class="line-content">-- Mechanic Integration Helpers</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1784</span>
                    <span class="line-content">-- ============================================================</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1785</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1786</span>
                    <span class="line-content">function FlightsimUI:GetPerformanceSubMetrics()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1787</span>
                    <span class="line-content">	local p = self.perf.blocks</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1788</span>
                    <span class="line-content">	return {</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1789</span>
                    <span class="line-content">		{ name = &quot;State &amp; Speed&quot;, msPerSec = p.state, description = &quot;Skyriding detection and raw speed APIs&quot; },</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1790</span>
                    <span class="line-content">		{ name = &quot;Speed Bar&quot;, msPerSec = p.speed, description = &quot;Speed percent calculation and HUD bar&quot; },</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1791</span>
                    <span class="line-content">		{ name = &quot;Accel Bar&quot;, msPerSec = p.accel, description = &quot;Acceleration delta calculation and UI&quot; },</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1792</span>
                    <span class="line-content">		{ name = &quot;Ability Prep&quot;, msPerSec = p.prep, description = &quot;Spell cooldown and charge polling&quot; },</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1793</span>
                    <span class="line-content">		{ name = &quot;Surge Forward&quot;, msPerSec = p.surge, description = &quot;Surge Forward charges and animations&quot; },</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1794</span>
                    <span class="line-content">		{ name = &quot;Whirling Surge&quot;, msPerSec = p.whirling, description = &quot;Whirling Surge cooldown bar&quot; },</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1795</span>
                    <span class="line-content">		{ name = &quot;Second Wind&quot;, msPerSec = p.wind, description = &quot;Second Wind charges and animations&quot; },</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1796</span>
                    <span class="line-content">	}</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1797</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1798</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1799</span>
                    <span class="line-content">function FlightsimUI:GetTests()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1800</span>
                    <span class="line-content">	return self.tests</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1801</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1802</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1803</span>
                    <span class="line-content">function FlightsimUI:RunTest(id)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1804</span>
                    <span class="line-content">	-- No-op for auto tests, they just return results</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1805</span>
                    <span class="line-content">	return true</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1806</span>
                    <span class="line-content">end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1807</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1808</span>
                    <span class="line-content">function FlightsimUI:GetTestResult(id)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1809</span>
                    <span class="line-content">	if id == &quot;api_diag&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1810</span>
                    <span class="line-content">		local details = {}</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1811</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1812</span>
                    <span class="line-content">		-- 1. GetUnitSpeed</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1813</span>
                    <span class="line-content">		local speed = GetUnitSpeedSafe(&quot;player&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1814</span>
                    <span class="line-content">		local speedSecret = IsSecret(speed)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1815</span>
                    <span class="line-content">		table.insert(details, {</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1816</span>
                    <span class="line-content">			label = &quot;GetUnitSpeed(\&quot;player\&quot;)&quot;,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1817</span>
                    <span class="line-content">			value = SafeToString(speed) .. (speedSecret and &quot; (SECRET)&quot; or &quot;&quot;),</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1818</span>
                    <span class="line-content">			status = speedSecret and &quot;warn&quot; or &quot;pass&quot;,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1819</span>
                    <span class="line-content">		})</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1820</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1821</span>
                    <span class="line-content">		-- 2. C_PlayerInfo.GetGlidingInfo</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1822</span>
                    <span class="line-content">		if C_PlayerInfo and C_PlayerInfo.GetGlidingInfo then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1823</span>
                    <span class="line-content">			local ok, gliding, canGlide, fwd = pcall(C_PlayerInfo.GetGlidingInfo)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1824</span>
                    <span class="line-content">			local fwdSecret = IsSecret(fwd)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1825</span>
                    <span class="line-content">			table.insert(details, {</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1826</span>
                    <span class="line-content">				label = &quot;C_PlayerInfo.GetGlidingInfo&quot;,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1827</span>
                    <span class="line-content">				value = string.format(&quot;gliding=%s, fwd=%s&quot;, tostring(gliding), SafeToString(fwd)),</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1828</span>
                    <span class="line-content">				status = fwdSecret and &quot;warn&quot; or &quot;pass&quot;,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1829</span>
                    <span class="line-content">			})</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1830</span>
                    <span class="line-content">		end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1831</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1832</span>
                    <span class="line-content">		-- 3. Surge Forward Charges</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1833</span>
                    <span class="line-content">		local info = GetSpellCooldownSafe(372608, true)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1834</span>
                    <span class="line-content">		local chargesSecret = IsSecret(info.currentCharges)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1835</span>
                    <span class="line-content">		table.insert(details, {</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1836</span>
                    <span class="line-content">			label = &quot;Surge Forward Charges&quot;,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1837</span>
                    <span class="line-content">			value = string.format(&quot;%s/%s&quot;, SafeToString(info.currentCharges), SafeToString(info.maxCharges)),</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1838</span>
                    <span class="line-content">			status = chargesSecret and &quot;warn&quot; or &quot;pass&quot;,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1839</span>
                    <span class="line-content">		})</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1840</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1841</span>
                    <span class="line-content">		return {</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1842</span>
                    <span class="line-content">			passed = true,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1843</span>
                    <span class="line-content">			message = chargesSecret and &quot;Running in Degraded (Combat) Mode&quot; or &quot;Running in Normal Mode&quot;,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1844</span>
                    <span class="line-content">			details = details,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1845</span>
                    <span class="line-content">		}</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1846</span>
                    <span class="line-content">	elseif id == &quot;ui_compliance&quot; then</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1847</span>
                    <span class="line-content">		local details = {}</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1848</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1849</span>
                    <span class="line-content">		-- 1. Speed Bar</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1850</span>
                    <span class="line-content">		table.insert(details, {</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1851</span>
                    <span class="line-content">			label = &quot;Speed Bar (StatusBar)&quot;,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1852</span>
                    <span class="line-content">			value = self.speedBar and &quot;Initialized&quot; or &quot;Missing&quot;,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1853</span>
                    <span class="line-content">			status = self.speedBar and &quot;pass&quot; or &quot;fail&quot;,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1854</span>
                    <span class="line-content">		})</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1855</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1856</span>
                    <span class="line-content">		-- 2. Passthrough Test</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1857</span>
                    <span class="line-content">		local speed = GetUnitSpeedSafe(&quot;player&quot;)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1858</span>
                    <span class="line-content">		local ok = pcall(function()</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1859</span>
                    <span class="line-content">			self.speedBar:SetValue(speed)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1860</span>
                    <span class="line-content">		end)</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1861</span>
                    <span class="line-content">		table.insert(details, {</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1862</span>
                    <span class="line-content">			label = &quot;Secret Passthrough&quot;,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1863</span>
                    <span class="line-content">			value = ok and &quot;Safe&quot; or &quot;CRASH&quot;,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1864</span>
                    <span class="line-content">			status = ok and &quot;pass&quot; or &quot;fail&quot;,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1865</span>
                    <span class="line-content">		})</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1866</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1867</span>
                    <span class="line-content">		return {</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1868</span>
                    <span class="line-content">			passed = ok,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1869</span>
                    <span class="line-content">			message = ok and &quot;UI elements are Midnight compliant&quot; or &quot;UI elements may crash in combat&quot;,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1870</span>
                    <span class="line-content">			details = details,</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1871</span>
                    <span class="line-content">		}</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1872</span>
                    <span class="line-content">	end</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1873</span>
                    <span class="line-content"></span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1874</span>
                    <span class="line-content">	return { passed = false, message = &quot;Unknown test ID&quot; }</span>
                </div>
        
                <div class="code-line ">
                    <span class="line-number">1875</span>
                    <span class="line-content">end</span>
                </div>
        
            </div>
        </div>
    
    </div>
</body>
</html>
